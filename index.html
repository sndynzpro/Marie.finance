<!DOCTYPE html>
<html class="dark" lang="es">
<head>
    <meta charset="utf-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover"/>
    <title>Marie Finance - App</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&display=swap" rel="stylesheet"/>
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Rounded:opsz,wght,FILL,GRAD@24,400,1,0" rel="stylesheet" />
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js/dist/chart.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>

    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>

    <script id="tailwind-config">
        tailwind.config = {
            darkMode: "class",
            theme: {
                extend: {
                    colors: {
                        "bg-dark": "#121212",
                        "card-dark": "#1e1e1e",
                        "primary": "#d4a373", // Tono arena/dorado de la imagen
                        "accent-green": "#4ade80",
                        "accent-red": "#f87171",
                        "text-main": "#ffffff",
                        "text-muted": "#a1a1aa",
                    },
                    fontFamily: {
                        "sans": ["Plus Jakarta Sans", "sans-serif"],
                    },
                    borderRadius: {
                        '3xl': '1.5rem',
                        '4xl': '2rem',
                    },
                    boxShadow: {
                        'glow': '0 0 20px -5px rgba(212, 163, 115, 0.3)',
                    }
                },
            },
        }
    </script>

    <style>
        body { 
            background-color: #121212; 
            color: #fff; 
            -webkit-tap-highlight-color: transparent;
            font-family: 'Plus Jakarta Sans', sans-serif;
        }
        
        /* Ocultar Scrollbar pero permitir scroll */
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }

        /* Inputs limpios */
        input:focus { outline: none; }
        input[type=number]::-webkit-inner-spin-button { -webkit-appearance: none; margin: 0; }

        /* Animaciones */
        .fade-in { animation: fadeIn 0.4s ease-out forwards; opacity: 0; transform: translateY(10px); }
        @keyframes fadeIn { to { opacity: 1; transform: translateY(0); } }

        /* Utilidades UI */
        .glass-card {
            background: #1e1e1e;
            border: 1px solid rgba(255,255,255,0.05);
            border-radius: 1.5rem;
        }
        
        .bottom-nav {
            background: rgba(30, 30, 30, 0.95);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border-top: 1px solid rgba(255,255,255,0.05);
            padding-bottom: env(safe-area-inset-bottom);
        }

        .fab-btn {
            background: linear-gradient(135deg, #d4a373, #b08968);
            box-shadow: 0 4px 15px rgba(212, 163, 115, 0.4);
        }

        /* Overlay para fondo de imagen en tarjeta meta */
        .goal-card-bg {
            background-image: url('https://images.unsplash.com/photo-1507525428034-b723cf961d3e?q=80&w=1000&auto=format&fit=crop'); 
            background-size: cover;
            background-position: center;
        }
        .goal-overlay {
            background: linear-gradient(to bottom, rgba(0,0,0,0.3), rgba(0,0,0,0.8));
        }
    </style>
</head>

<body class="min-h-screen flex flex-col pb-24 overflow-x-hidden selection:bg-primary selection:text-black">

    <div id="loginOverlay" class="fixed inset-0 z-50 bg-[#121212] flex items-center justify-center p-6 transition-opacity duration-500">
        <div class="w-full max-w-sm text-center">
            <div class="w-24 h-24 rounded-full bg-primary/20 mx-auto mb-6 flex items-center justify-center animate-pulse">
                <span class="material-symbols-rounded text-5xl text-primary">savings</span>
            </div>
            <h1 class="text-3xl font-bold mb-2">Marie Finance</h1>
            <p class="text-text-muted mb-8 text-sm">Tus finanzas, pero con estilo.</p>
            <button onclick="Auth.login()" class="w-full py-4 rounded-2xl bg-white text-black font-bold flex items-center justify-center gap-3 active:scale-95 transition-transform">
                <img src="https://www.svgrepo.com/show/475656/google-color.svg" class="w-5 h-5" alt="G">
                <span>Entrar con Google</span>
            </button>
        </div>
    </div>

    <div id="appContent" class="flex-1 w-full max-w-md mx-auto px-5 pt-4 opacity-0 transition-opacity duration-500">
        
        <header class="flex justify-between items-center mb-6">
            <div class="flex items-center gap-3">
                <div class="relative">
                    <div class="w-10 h-10 rounded-full bg-stone-700 overflow-hidden border border-white/10">
                        <img src="https://api.dicebear.com/7.x/avataaars/svg?seed=Marie" alt="Avatar" class="w-full h-full object-cover">
                    </div>
                    <div class="absolute bottom-0 right-0 w-3 h-3 bg-accent-green rounded-full border-2 border-[#121212]"></div>
                </div>
                <div>
                    <p class="text-[10px] font-medium text-text-muted uppercase tracking-wider" id="headerDate">HOY, 24 OCT</p>
                    <div class="flex items-center gap-1.5 cursor-pointer group" onclick="App.openProfileModal()">
                        <h1 class="text-xl font-bold text-white leading-none">¡Epa, <span id="userNameDisplay">Marie</span>!</h1>
                        <span class="material-symbols-rounded text-xs text-text-muted group-hover:text-primary transition-colors">edit</span>
                    </div>
                </div>
            </div>
            <button class="w-10 h-10 rounded-full bg-card-dark flex items-center justify-center border border-white/5 active:scale-95 transition-transform">
                <span class="material-symbols-rounded text-text-muted">notifications</span>
            </button>
        </header>

        <div id="view-home" class="view-section fade-in">
            <div class="flex justify-between items-end mb-3 px-1">
                <h2 class="text-base font-bold">Tu Meta</h2>
                <button onclick="App.navigateTo('wallet')" class="text-xs text-primary font-medium hover:text-white transition-colors">Ver billetera</button>
            </div>

            <div class="w-full aspect-[16/9] rounded-3xl relative overflow-hidden mb-8 shadow-glow cursor-pointer group" onclick="App.openGoalModal()">
                <div class="absolute inset-0 goal-card-bg transition-transform duration-700 group-hover:scale-105"></div>
                <div class="absolute inset-0 goal-overlay p-6 flex flex-col justify-between">
                    <div class="flex justify-between items-start">
                        <span class="bg-white/20 backdrop-blur-md px-3 py-1 rounded-lg text-xs font-semibold text-white border border-white/10">Ahorro</span>
                        <div class="w-10 h-10 rounded-full bg-white/20 backdrop-blur-md flex items-center justify-center text-white">
                            <span class="material-symbols-rounded">flight_takeoff</span>
                        </div>
                    </div>
                    <div>
                        <h3 class="text-xl font-bold text-white mb-4">Meta Financiera</h3>
                        <p class="text-[10px] font-bold text-white/60 uppercase tracking-widest mb-1">PLATA GUARDADA</p>
                        <div class="flex justify-between items-end mb-3">
                            <div class="flex items-baseline gap-1">
                                <span class="text-3xl font-bold text-white" id="cardSavedDisplay">$0</span>
                                <span class="text-sm text-white/50 font-medium" id="cardGoalDisplay">/ $0</span>
                            </div>
                            <span class="text-lg font-bold text-primary" id="cardPercentDisplay">0%</span>
                        </div>
                        <div class="w-full h-1.5 bg-white/10 rounded-full overflow-hidden">
                            <div id="cardProgressBar" class="h-full bg-primary rounded-full transition-all duration-1000 w-0"></div>
                        </div>
                    </div>
                </div>
            </div>

            <h2 class="text-base font-bold mb-3 px-1">La Movida</h2>
            
            <div class="grid grid-cols-2 gap-4 mb-8">
                <div class="glass-card p-5 relative overflow-hidden flex flex-col justify-between min-h-[140px]">
                    <div class="absolute bottom-0 left-0 w-full h-12 bg-accent-green/5 rounded-b-3xl">
                         <svg class="w-full h-full text-accent-green/20" viewBox="0 0 100 40" preserveAspectRatio="none"><path d="M0,40 Q50,0 100,40" fill="currentColor"/></svg>
                    </div>
                    <div class="flex justify-between items-start mb-4">
                        <div class="w-8 h-8 rounded-full bg-accent-green/10 flex items-center justify-center">
                            <span class="material-symbols-rounded text-accent-green text-sm">arrow_downward</span>
                        </div>
                        <span class="text-[10px] font-bold bg-accent-green/10 text-accent-green px-1.5 py-0.5 rounded flex items-center gap-0.5">
                            <span class="material-symbols-rounded text-[10px]">trending_up</span> OK
                        </span>
                    </div>
                    <div>
                        <p class="text-xs text-text-muted font-medium mb-1">Lo que entra</p>
                        <p class="text-2xl font-bold text-white tracking-tight" id="dashboardIncome">$0</p>
                    </div>
                </div>
                
                <div class="glass-card p-5 relative overflow-hidden flex flex-col justify-between min-h-[140px]">
                     <div class="absolute bottom-0 left-0 w-full h-12 bg-accent-red/5 rounded-b-3xl">
                         <svg class="w-full h-full text-accent-red/20" viewBox="0 0 100 40" preserveAspectRatio="none"><path d="M0,40 Q50,10 100,40" fill="currentColor"/></svg>
                    </div>
                    <div class="flex justify-between items-start mb-4">
                        <div class="w-8 h-8 rounded-full bg-accent-red/10 flex items-center justify-center">
                            <span class="material-symbols-rounded text-accent-red text-sm">arrow_upward</span>
                        </div>
                         <span class="text-[10px] font-bold bg-accent-red/10 text-accent-red px-1.5 py-0.5 rounded flex items-center gap-0.5">
                            <span class="material-symbols-rounded text-[10px]">trending_down</span> !
                        </span>
                    </div>
                    <div>
                        <p class="text-xs text-text-muted font-medium mb-1">Lo que sale</p>
                        <p class="text-2xl font-bold text-white tracking-tight" id="dashboardExpense">$0</p>
                    </div>
                </div>
            </div>

            <h2 class="text-base font-bold mb-3 px-1">Pilas con esto</h2>
            <div class="space-y-3 pb-6" id="alertsList">
                <div class="glass-card p-4 flex items-center gap-4 active:scale-[0.98] transition-transform">
                    <div class="w-10 h-10 rounded-full bg-orange-500/20 flex items-center justify-center shrink-0">
                         <span class="material-symbols-rounded text-orange-500">lunch_dining</span>
                    </div>
                    <div class="flex-1 min-w-0">
                        <h4 class="text-sm font-bold text-white truncate">Analizando gastos...</h4>
                        <p class="text-xs text-text-muted truncate">Revisando tu historial reciente.</p>
                    </div>
                    <span class="material-symbols-rounded text-text-muted text-sm">chevron_right</span>
                </div>
            </div>
        </div>

        <div id="view-wallet" class="view-section hidden fade-in">
            <h2 class="text-xl font-bold mb-6">Tu Billetera</h2>
            
            <div class="flex p-1 bg-card-dark rounded-xl mb-6">
                <button onclick="App.switchWalletTab('income')" id="tab-income" class="flex-1 py-2 rounded-lg text-xs font-bold bg-white text-black shadow-sm transition-all">Ingresos</button>
                <button onclick="App.switchWalletTab('expense')" id="tab-expense" class="flex-1 py-2 rounded-lg text-xs font-bold text-text-muted hover:text-white transition-all">Gastos</button>
            </div>

            <div id="walletListContainer" class="space-y-3 pb-10"></div>
             <div id="walletEmptyState" class="hidden flex-col items-center justify-center py-10 text-center opacity-50">
                <span class="material-symbols-rounded text-4xl mb-2">inbox</span>
                <p class="text-sm">Nada por aquí aún.</p>
            </div>
        </div>

        <div id="view-chart" class="view-section hidden fade-in">
            <h2 class="text-xl font-bold mb-6">Historial</h2>
            <div class="glass-card p-4 h-64 mb-6">
                <canvas id="mainChart"></canvas>
            </div>
            <div id="historyList" class="space-y-3 pb-6"></div>
        </div>

    </div>

    <div id="transactionModal" class="fixed inset-0 z-40 hidden">
        <div class="absolute inset-0 bg-black/60 backdrop-blur-sm transition-opacity" onclick="App.closeTransactionModal()"></div>
        <div class="absolute bottom-0 left-0 w-full bg-[#1e1e1e] rounded-t-[2rem] p-6 transform transition-transform duration-300 translate-y-full" id="transactionPanel">
            <div class="w-12 h-1 bg-white/10 rounded-full mx-auto mb-6"></div>
            
            <div class="text-center mb-8">
                <span class="text-xs font-bold text-text-muted uppercase tracking-widest block mb-2" id="modalTypeTitle">NUEVO MOVIMIENTO</span>
                <div class="flex justify-center items-center gap-2">
                    <span class="text-3xl font-light text-text-muted">$</span>
                    <input type="number" id="modalAmountInput" placeholder="0" class="bg-transparent text-5xl font-bold text-white w-40 text-center placeholder-white/10 p-0 border-none outline-none focus:ring-0">
                </div>
            </div>

            <div class="bg-black/20 rounded-2xl p-2 mb-6">
                <input type="text" id="modalDescInput" placeholder="¿Qué es este movimiento?" class="w-full bg-transparent text-center text-sm p-3 text-white placeholder-text-muted border-none focus:ring-0">
            </div>

            <div class="grid grid-cols-2 gap-3">
                <button onclick="App.confirmTransaction('expense')" class="py-4 rounded-xl bg-accent-red/10 text-accent-red font-bold text-sm border border-accent-red/20 active:scale-95 transition-transform flex flex-col items-center gap-1">
                    <span class="material-symbols-rounded">arrow_upward</span>
                    Es un Gasto
                </button>
                <button onclick="App.confirmTransaction('income')" class="py-4 rounded-xl bg-accent-green/10 text-accent-green font-bold text-sm border border-accent-green/20 active:scale-95 transition-transform flex flex-col items-center gap-1">
                    <span class="material-symbols-rounded">arrow_downward</span>
                    Es un Ingreso
                </button>
            </div>
        </div>
    </div>

    <div id="goalModal" class="fixed inset-0 z-40 hidden flex items-center justify-center px-6">
        <div class="absolute inset-0 bg-black/80 backdrop-blur-sm" onclick="App.closeGoalModal()"></div>
        <div class="relative bg-[#1e1e1e] w-full max-w-sm rounded-3xl p-6 border border-white/10">
            <h3 class="text-lg font-bold mb-4 text-center">Configurar Meta</h3>
            <label class="text-xs text-text-muted font-bold ml-1 mb-2 block">MONTO OBJETIVO ($)</label>
            <input type="number" id="goalInput" class="w-full bg-black/20 rounded-xl p-4 text-xl font-bold text-white mb-6 border border-white/5 focus:border-primary/50 text-center" placeholder="5000">
            
            <button onclick="App.saveGoal()" class="w-full py-3.5 bg-primary text-black font-bold rounded-xl active:scale-95 transition-transform">Guardar Meta</button>
        </div>
    </div>

    <div id="profileModal" class="fixed inset-0 z-40 hidden flex items-center justify-center px-6">
        <div class="absolute inset-0 bg-black/80 backdrop-blur-sm" onclick="App.closeProfileModal()"></div>
        <div class="relative bg-[#1e1e1e] w-full max-w-sm rounded-3xl p-6 border border-white/10">
            <h3 class="text-lg font-bold mb-4 text-center">Editar Perfil</h3>
            <label class="text-xs text-text-muted font-bold ml-1 mb-2 block">TU NOMBRE</label>
            <input type="text" id="profileNameInput" class="w-full bg-black/20 rounded-xl p-4 text-lg font-medium text-white mb-6 border border-white/5 focus:border-primary/50 text-center" placeholder="Marie">
            
            <button onclick="App.saveProfile()" class="w-full py-3.5 bg-white text-black font-bold rounded-xl active:scale-95 transition-transform">Listo</button>
        </div>
    </div>

    <nav class="fixed bottom-0 left-0 w-full bottom-nav z-30">
        <div class="flex justify-between items-center px-6 py-2 max-w-md mx-auto relative">
            
            <button onclick="App.navigateTo('home')" class="p-2 text-primary nav-btn active" data-target="home">
                <span class="material-symbols-rounded text-2xl">home</span>
            </button>
            
            <button onclick="App.navigateTo('wallet')" class="p-2 text-text-muted hover:text-white transition-colors nav-btn" data-target="wallet">
                <span class="material-symbols-rounded text-2xl">account_balance_wallet</span>
            </button>

            <button onclick="App.openTransactionModal()" class="w-14 h-14 rounded-full fab-btn flex items-center justify-center text-black -mt-8 shadow-glow active:scale-95 transition-transform">
                <span class="material-symbols-rounded text-3xl">add</span>
            </button>

            <button onclick="App.navigateTo('chart')" class="p-2 text-text-muted hover:text-white transition-colors nav-btn" data-target="chart">
                <span class="material-symbols-rounded text-2xl">bar_chart</span>
            </button>

            <button onclick="App.openProfileModal()" class="p-2 text-text-muted hover:text-white transition-colors">
                <span class="material-symbols-rounded text-2xl">person</span>
            </button>
        </div>
    </nav>

    <script>
        /**
         * MARIE FINANCE V2 - MOBILE FIRST REDESIGN
         * Lógica mantenida, UI totalmente renovada según referencia.
         */

        const CONFIG = {
            firebase: {
                apiKey: "AIzaSyANBc8ziutAX47V_iJpgdn-7O3S3kvI3Tc",
                authDomain: "marie-finance.firebaseapp.com",
                projectId: "marie-finance",
                storageBucket: "marie-finance.firebasestorage.app",
                messagingSenderId: "754175935134",
                appId: "1:754175935134:web:d159ae64d6ce56f51f318f",
                measurementId: "G-NX06QJHXL9"
            },
            collections: { users: 'users' }
        };

        // Estado Global
        let state = {
            userName: '',
            goal: 5000,
            accumulated: 0,
            salary: 0,
            incomes: [], // { id, name, amount }
            expenses: [], // { id, name, amount }
            history: [] // { id, date, desc, amount, type }
        };

        let currentWalletTab = 'income'; // 'income' | 'expense'
        let chartInstance = null;
        let firebaseAuth = null;
        let firestoreDb = null;

        // --- UTILIDADES ---
        const Utils = {
            $: (id) => document.getElementById(id),
            formatMoney: (v) => new Intl.NumberFormat('en-US', { style: 'currency', currency: 'USD', maximumFractionDigits: 0 }).format(v),
            getDateString: () => {
                const now = new Date();
                const day = now.getDate();
                const month = now.toLocaleString('es-ES', { month: 'short' }).toUpperCase().replace('.', '');
                return `HOY, ${day} ${month}`;
            }
        };

        // --- AUTH & DATA ---
        const Auth = {
            init: () => {
                try {
                    firebase.initializeApp(CONFIG.firebase);
                    firebaseAuth = firebase.auth();
                    firestoreDb = firebase.firestore();
                    Auth.monitor();
                } catch (e) {
                    console.error("Firebase Error:", e);
                }
            },
            monitor: () => {
                firebaseAuth.onAuthStateChanged(user => {
                    const overlay = Utils.$('loginOverlay');
                    const content = Utils.$('appContent');
                    if (user) {
                        overlay.classList.add('hidden');
                        content.classList.remove('opacity-0');
                        Data.load(user.uid);
                    } else {
                        overlay.classList.remove('hidden');
                        content.classList.add('opacity-0');
                    }
                });
            },
            login: () => {
                const provider = new firebase.auth.GoogleAuthProvider();
                firebaseAuth.signInWithPopup(provider).catch(console.error);
            }
        };

        const Data = {
            load: async (uid) => {
                const docRef = firestoreDb.collection(CONFIG.collections.users).doc(uid);
                const doc = await docRef.get();
                if (doc.exists) {
                    // Migración simple de datos viejos si existen
                    let data = doc.data();
                    state = { ...state, ...data };
                    // Asegurar arrays
                    if(!state.incomes) state.incomes = [];
                    if(!state.expenses) state.expenses = [];
                } else {
                    const user = firebaseAuth.currentUser;
                    state.userName = user.displayName ? user.displayName.split(' ')[0] : 'Marie';
                    Data.save();
                }
                App.renderAll();
            },
            save: () => {
                const user = firebaseAuth.currentUser;
                if (user && firestoreDb) {
                    firestoreDb.collection(CONFIG.collections.users).doc(user.uid).set(state, { merge: true });
                }
            }
        };

        // --- UI RENDER ---
        const UI = {
            updateDashboard: () => {
                // Cálculos
                const totalIncome = state.incomes.reduce((acc, i) => acc + (parseFloat(i.amount)||0), 0) + (state.salary||0);
                const totalExpense = state.expenses.reduce((acc, e) => acc + (parseFloat(e.amount)||0), 0);
                // "Plata Guardada" es el acumulado manual + (ingresos - gastos), simplificado aquí como state.accumulated para la meta
                // Nota: En la versión anterior la lógica era compleja. Aquí simplificamos para la UI nueva.
                // Asumimos que state.accumulated es el "Ahorro Real" disponible.
                
                // Header
                Utils.$('headerDate').innerText = Utils.getDateString();
                Utils.$('userNameDisplay').innerText = state.userName || 'Marie';

                // Tarjeta Meta
                Utils.$('cardSavedDisplay').innerText = Utils.formatMoney(state.accumulated);
                Utils.$('cardGoalDisplay').innerText = `/ ${Utils.formatMoney(state.goal)}`;
                
                const percent = Math.min(100, Math.round((state.accumulated / state.goal) * 100)) || 0;
                Utils.$('cardPercentDisplay').innerText = `${percent}%`;
                Utils.$('cardProgressBar').style.width = `${percent}%`;

                // Tarjetas Movida
                Utils.$('dashboardIncome').innerText = `+${Utils.formatMoney(totalIncome)}`;
                Utils.$('dashboardExpense').innerText = `-${Utils.formatMoney(totalExpense)}`;

                // Alertas (Lógica simple simulada)
                const alertsList = Utils.$('alertsList');
                alertsList.innerHTML = '';
                
                // Alerta Gastos Altos
                if (totalExpense > totalIncome * 0.8 && totalIncome > 0) {
                    UI.addAlert('warning', 'fastfood', '¡Cuidado con los gastos!', 'Estás al 80% de tus ingresos.');
                }
                // Alerta Meta Lejos
                if (percent < 10) {
                    UI.addAlert('info', 'flag', 'La meta está lejos', 'Intenta guardar un poco hoy.');
                }
                // Alerta Genérica Positiva
                if (totalExpense < totalIncome * 0.3 && totalIncome > 0) {
                    UI.addAlert('success', 'verified', 'Finanzas Saludables', 'Tienes buen margen de ahorro.');
                }
                // Fallback si no hay alertas
                if (alertsList.children.length === 0) {
                    UI.addAlert('neutral', 'check_circle', 'Todo en orden', 'No hay alertas urgentes hoy.');
                }
            },

            addAlert: (type, icon, title, subtitle) => {
                const colors = {
                    warning: 'text-orange-500 bg-orange-500/20',
                    info: 'text-blue-500 bg-blue-500/20',
                    success: 'text-green-500 bg-green-500/20',
                    neutral: 'text-text-muted bg-white/10'
                };
                const theme = colors[type] || colors.neutral;
                
                Utils.$('alertsList').innerHTML += `
                <div class="glass-card p-4 flex items-center gap-4">
                    <div class="w-10 h-10 rounded-full ${theme.split(' ')[1]} flex items-center justify-center shrink-0">
                         <span class="material-symbols-rounded ${theme.split(' ')[0]}">${icon}</span>
                    </div>
                    <div class="flex-1 min-w-0">
                        <h4 class="text-sm font-bold text-white truncate">${title}</h4>
                        <p class="text-xs text-text-muted truncate">${subtitle}</p>
                    </div>
                </div>`;
            },

            renderWalletList: () => {
                const list = Utils.$('walletListContainer');
                const empty = Utils.$('walletEmptyState');
                list.innerHTML = '';
                
                const items = currentWalletTab === 'income' ? state.incomes : state.expenses;
                
                // Toggle visual tab state
                const btnInc = Utils.$('tab-income');
                const btnExp = Utils.$('tab-expense');
                
                if(currentWalletTab === 'income') {
                    btnInc.className = "flex-1 py-2 rounded-lg text-xs font-bold bg-white text-black shadow-sm transition-all";
                    btnExp.className = "flex-1 py-2 rounded-lg text-xs font-bold text-text-muted hover:text-white transition-all";
                } else {
                    btnInc.className = "flex-1 py-2 rounded-lg text-xs font-bold text-text-muted hover:text-white transition-all";
                    btnExp.className = "flex-1 py-2 rounded-lg text-xs font-bold bg-white text-black shadow-sm transition-all";
                }

                if (items.length === 0) {
                    empty.classList.remove('hidden');
                    empty.classList.add('flex');
                    return;
                } else {
                    empty.classList.add('hidden');
                    empty.classList.remove('flex');
                }

                items.forEach(item => {
                    // Diseño "Full Width" para que se vea el nombre completo
                    list.innerHTML += `
                    <div class="glass-card p-4 flex items-center justify-between group">
                        <div class="flex-1 mr-4">
                            <input type="text" value="${item.name}" onchange="App.updateItemName('${currentWalletTab}', ${item.id}, this.value)" class="bg-transparent font-bold text-white text-sm w-full p-0 border-none focus:ring-0 placeholder-text-muted/50" placeholder="Nombre...">
                        </div>
                        <div class="flex items-center gap-3">
                            <div class="flex items-center gap-1 bg-black/20 rounded-lg px-2 py-1">
                                <span class="text-xs text-text-muted">$</span>
                                <input type="number" value="${item.amount}" onchange="App.updateItemAmount('${currentWalletTab}', ${item.id}, this.value)" class="bg-transparent font-mono font-medium text-white text-right w-16 p-0 border-none focus:ring-0 text-sm">
                            </div>
                            <button onclick="App.deleteItem('${currentWalletTab}', ${item.id})" class="text-text-muted hover:text-accent-red transition-colors p-1">
                                <span class="material-symbols-rounded text-lg">delete</span>
                            </button>
                        </div>
                    </div>`;
                });
                
                // Botón para añadir item en lista vacía o llena
                list.innerHTML += `
                    <button onclick="App.addListItem('${currentWalletTab}')" class="w-full py-3 rounded-xl border border-dashed border-white/20 text-xs text-text-muted font-bold hover:bg-white/5 transition-colors uppercase tracking-widest mt-4">
                        + Agregar ${currentWalletTab === 'income' ? 'Ingreso' : 'Gasto'} Fijo
                    </button>
                `;
            },

            renderChart: () => {
                const ctx = Utils.$('mainChart');
                if(!ctx) return;
                
                // Preparar datos
                const history = [...state.history].sort((a,b) => a.id - b.id); // Cronológico
                const labels = history.map(h => new Date(h.date).toLocaleDateString(undefined, {day:'2-digit', month:'short'}));
                const dataPoints = history.map(h => h.amount); // Solo magnitud por ahora, o acumulado

                if(chartInstance) chartInstance.destroy();

                chartInstance = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: labels,
                        datasets: [{
                            label: 'Movimientos',
                            data: dataPoints,
                            borderColor: '#d4a373',
                            backgroundColor: 'rgba(212, 163, 115, 0.1)',
                            borderWidth: 2,
                            tension: 0.4,
                            pointRadius: 3,
                            fill: true
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: { legend: { display: false } },
                        scales: {
                            x: { display: false },
                            y: { display: false }
                        }
                    }
                });

                // Lista historial
                const hList = Utils.$('historyList');
                hList.innerHTML = '';
                [...state.history].sort((a,b) => b.id - a.id).slice(0, 10).forEach(h => {
                    const isExp = h.type === 'expense';
                    hList.innerHTML += `
                    <div class="flex justify-between items-center py-3 border-b border-white/5 last:border-0">
                        <div>
                            <p class="text-sm font-bold text-white">${h.desc || 'Sin descripción'}</p>
                            <p class="text-xs text-text-muted">${new Date(h.date).toLocaleDateString()}</p>
                        </div>
                        <span class="font-mono font-bold ${isExp ? 'text-accent-red' : 'text-accent-green'}">
                            ${isExp ? '-' : '+'}${Utils.formatMoney(h.amount)}
                        </span>
                    </div>`;
                });
            }
        };

        // --- APP LOGIC ---
        const App = {
            init: () => {
                Auth.init();
            },

            renderAll: () => {
                UI.updateDashboard();
                UI.renderWalletList();
                UI.renderChart();
            },

            navigateTo: (viewId) => {
                document.querySelectorAll('.view-section').forEach(el => el.classList.add('hidden'));
                Utils.$(`view-${viewId}`).classList.remove('hidden');
                
                // Nav styles
                document.querySelectorAll('.nav-btn').forEach(btn => {
                    btn.classList.remove('text-primary');
                    btn.classList.add('text-text-muted');
                    if(btn.dataset.target === viewId) {
                        btn.classList.remove('text-text-muted');
                        btn.classList.add('text-primary');
                    }
                });

                if (viewId === 'wallet') UI.renderWalletList();
                if (viewId === 'chart') UI.renderChart();
            },

            // --- Wallet Logic ---
            switchWalletTab: (tab) => {
                currentWalletTab = tab;
                UI.renderWalletList();
            },
            
            addListItem: (type) => {
                const newItem = { id: Date.now(), name: '', amount: 0 };
                if (type === 'income') state.incomes.push(newItem);
                else state.expenses.push(newItem);
                UI.renderWalletList();
                Data.save();
            },

            updateItemName: (type, id, val) => {
                const list = type === 'income' ? state.incomes : state.expenses;
                const item = list.find(i => i.id === id);
                if(item) { item.name = val; Data.save(); }
            },

            updateItemAmount: (type, id, val) => {
                const list = type === 'income' ? state.incomes : state.expenses;
                const item = list.find(i => i.id === id);
                if(item) { item.amount = parseFloat(val) || 0; Data.save(); UI.updateDashboard(); }
            },

            deleteItem: (type, id) => {
                if (type === 'income') state.incomes = state.incomes.filter(i => i.id !== id);
                else state.expenses = state.expenses.filter(i => i.id !== id);
                UI.renderWalletList();
                UI.updateDashboard();
                Data.save();
            },

            // --- Transaction Modal ---
            openTransactionModal: () => {
                Utils.$('transactionModal').classList.remove('hidden');
                setTimeout(() => Utils.$('transactionPanel').classList.remove('translate-y-full'), 10);
            },
            closeTransactionModal: () => {
                Utils.$('transactionPanel').classList.add('translate-y-full');
                setTimeout(() => {
                    Utils.$('transactionModal').classList.add('hidden');
                    Utils.$('modalAmountInput').value = '';
                    Utils.$('modalDescInput').value = '';
                }, 300);
            },
            confirmTransaction: (type) => {
                const amount = parseFloat(Utils.$('modalAmountInput').value);
                const desc = Utils.$('modalDescInput').value || (type === 'income' ? 'Ingreso Extra' : 'Gasto Varios');

                if(!amount) return;

                // Actualizar acumulado (Meta)
                if(type === 'income') state.accumulated += amount;
                else state.accumulated = Math.max(0, state.accumulated - amount);

                // Agregar a historial
                state.history.push({
                    id: Date.now(),
                    date: new Date().toISOString(),
                    desc: desc,
                    amount: amount,
                    type: type
                });

                Data.save();
                UI.updateDashboard();
                App.closeTransactionModal();
                
                // Efecto visual
                if(type === 'income') {
                    confetti({ particleCount: 50, spread: 60, origin: { y: 0.8 }, colors: ['#4ade80', '#ffffff'] });
                }
            },

            // --- Goal & Profile Modals ---
            openGoalModal: () => {
                Utils.$('goalInput').value = state.goal;
                Utils.$('goalModal').classList.remove('hidden');
            },
            closeGoalModal: () => Utils.$('goalModal').classList.add('hidden'),
            saveGoal: () => {
                const val = parseFloat(Utils.$('goalInput').value);
                if(val) { state.goal = val; Data.save(); UI.updateDashboard(); }
                App.closeGoalModal();
            },

            openProfileModal: () => {
                Utils.$('profileNameInput').value = state.userName;
                Utils.$('profileModal').classList.remove('hidden');
            },
            closeProfileModal: () => Utils.$('profileModal').classList.add('hidden'),
            saveProfile: () => {
                const val = Utils.$('profileNameInput').value.trim();
                if(val) { state.userName = val; Data.save(); UI.updateDashboard(); }
                App.closeProfileModal();
            }
        };

        // Init
        document.addEventListener('DOMContentLoaded', App.init);

    </script>
</body>
</html>
