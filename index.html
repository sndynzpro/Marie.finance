<!DOCTYPE html>
<html class="dark" lang="es">
<head>
    <meta charset="utf-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"/>
    <title>Marie Finance - Info Edition</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&family=Inter:wght@400;500;600&display=swap" rel="stylesheet"/>
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Rounded:opsz,wght,FILL,GRAD@24,400,1,0" rel="stylesheet" />
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js/dist/chart.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns/dist/chartjs-adapter-date-fns.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>

    <script id="tailwind-config">
        tailwind.config = {
            darkMode: "class",
            theme: {
                extend: {
                    colors: {
                        "primary": "#d48d9e",       
                        "bg-light": "#fdfbf7",
                        "surface-light": "#ffffff",
                        "text-main-light": "#2d2424",
                        "text-muted-light": "#6b5e5e",
                        
                        "bg-dark": "#121010",
                        "surface-dark": "#1f1a1a",
                        "text-main-dark": "#f3e8e8",
                        "text-muted-dark": "#a89898",
                        
                        "success": "#10b981",       
                        "danger": "#ef4444",        
                        "warning": "#f59e0b",       
                    },
                    fontFamily: {
                        "display": ["Plus Jakarta Sans", "sans-serif"],
                        "body": ["Inter", "sans-serif"],
                    },
                    boxShadow: {
                        'soft': '0 8px 24px -4px rgba(0, 0, 0, 0.04)',
                        'glow': '0 0 15px rgba(212, 141, 158, 0.3)',
                    }
                },
            },
        }
    </script>
    <style>
        body { 
            -webkit-tap-highlight-color: transparent; 
            transition: background-color 0.4s ease, color 0.4s ease;
        }

        /* Scrollbar */
        ::-webkit-scrollbar { width: 4px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: rgba(212, 141, 158, 0.3); border-radius: 10px; }
        
        /* Sliders */
        input[type=range] { -webkit-appearance: none; background: transparent; }
        input[type=range]::-webkit-slider-thumb {
            -webkit-appearance: none; height: 24px; width: 24px;
            border-radius: 50%; background: #d48d9e; cursor: pointer;
            margin-top: -10px; box-shadow: 0 2px 6px rgba(0,0,0,0.2); border: 2px solid white;
        }
        input[type=range]::-webkit-slider-runnable-track { width: 100%; height: 4px; background: #e5e7eb; border-radius: 2px; }
        .dark input[type=range]::-webkit-slider-runnable-track { background: #333; }

        input[type=number]::-webkit-inner-spin-button, input[type=number]::-webkit-outer-spin-button { -webkit-appearance: none; margin: 0; }
        
        .glass-sheet {
            background: rgba(255, 255, 255, 0.95);
            border-top: 1px solid rgba(0,0,0,0.05);
        }
        .dark .glass-sheet {
            background: rgba(31, 26, 26, 0.95);
            border-top: 1px solid rgba(255,255,255,0.1);
        }

        .view-section { display: none; animation: fadeIn 0.4s cubic-bezier(0.16, 1, 0.3, 1); }
        .view-section.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body class="bg-bg-light dark:bg-bg-dark text-text-main-light dark:text-text-main-dark font-body min-h-screen flex flex-col selection:bg-primary selection:text-white">

    <div class="fixed top-0 w-full z-50 px-5 py-4 flex items-center justify-between bg-bg-light/95 dark:bg-bg-dark/95 backdrop-blur-md border-b border-black/5 dark:border-white/5 transition-all">
        <div class="flex items-center gap-3">
            <button id="backBtn" onclick="navigateTo('home')" class="hidden w-9 h-9 rounded-full bg-gray-100 dark:bg-white/10 flex items-center justify-center text-text-muted-light dark:text-text-muted-dark active:scale-90 transition-all hover:bg-gray-200 dark:hover:bg-white/20">
                <span class="material-symbols-rounded text-lg">arrow_back</span>
            </button>
            <div class="flex flex-col">
                <span id="pageTitleLabel" class="text-[9px] font-black tracking-[0.25em] uppercase text-primary">MENÚ</span>
                <span id="pageTitleMain" class="text-sm font-bold font-display text-text-main-light dark:text-text-main-dark">Marie<span class="text-primary">.App</span></span>
            </div>
        </div>
        <button id="themeToggle" class="w-10 h-10 rounded-full bg-surface-light dark:bg-surface-dark border border-gray-200 dark:border-white/10 flex items-center justify-center text-primary shadow-soft active:scale-95 transition-transform hover:shadow-md">
             <span class="material-symbols-rounded">contrast</span>
        </button>
    </div>

    <div class="flex-1 overflow-y-auto w-full max-w-md mx-auto px-5 pt-24 pb-48">

        <div id="view-home" class="view-section active">
            
            <div class="grid grid-cols-2 gap-5 mb-8">
                
                <button onclick="navigateTo('goal')" class="col-span-2 bg-surface-light dark:bg-surface-dark p-6 rounded-3xl border border-gray-100 dark:border-white/5 shadow-soft hover:shadow-lg transition-all active:scale-[0.98] text-left group relative overflow-hidden">
                    <div class="absolute right-[-10px] top-[-10px] p-4 opacity-5 group-hover:opacity-10 group-hover:scale-110 transition-all duration-500">
                        <span class="material-symbols-rounded text-8xl text-primary">flag</span>
                    </div>
                    <div class="relative z-10">
                        <div class="flex items-center justify-between mb-3">
                            <div class="w-10 h-10 rounded-xl bg-primary/10 flex items-center justify-center text-primary">
                                <span class="material-symbols-rounded text-2xl">flag</span>
                            </div>
                            <div class="inline-block bg-bg-light dark:bg-white/5 px-3 py-1 rounded-full text-xs font-bold text-primary border border-primary/20" id="menuGoalSummary">$0</div>
                        </div>
                        <h3 class="font-bold text-lg text-text-main-light dark:text-text-main-dark mb-1">Objetivo & Ahorro</h3>
                        <p class="text-[11px] text-text-muted-light dark:text-text-muted-dark leading-relaxed opacity-80 pr-8">
                            Define tu meta final y gestiona el capital que ya tienes acumulado.
                        </p>
                    </div>
                </button>

                <button onclick="navigateTo('incomes')" class="bg-surface-light dark:bg-surface-dark p-5 rounded-3xl border border-gray-100 dark:border-white/5 shadow-soft hover:shadow-lg transition-all active:scale-[0.98] text-left flex flex-col justify-between h-40">
                    <div>
                        <div class="w-9 h-9 rounded-lg bg-emerald-500/10 flex items-center justify-center text-success mb-3">
                            <span class="material-symbols-rounded text-xl">attach_money</span>
                        </div>
                        <h3 class="font-bold text-base text-text-main-light dark:text-text-main-dark">Ingresos</h3>
                        <p class="text-[10px] text-text-muted-light dark:text-text-muted-dark mt-1 opacity-70 leading-tight truncate">
                            Calcula sueldos y ventas.
                        </p>
                    </div>
                    <div class="text-sm font-black text-success mt-2 truncate" id="menuIncomeSummary">$0</div>
                </button>

                <button onclick="navigateTo('expenses')" class="bg-surface-light dark:bg-surface-dark p-5 rounded-3xl border border-gray-100 dark:border-white/5 shadow-soft hover:shadow-lg transition-all active:scale-[0.98] text-left flex flex-col justify-between h-40">
                    <div>
                        <div class="w-9 h-9 rounded-lg bg-rose-500/10 flex items-center justify-center text-danger mb-3">
                            <span class="material-symbols-rounded text-xl">credit_card</span>
                        </div>
                        <h3 class="font-bold text-base text-text-main-light dark:text-text-main-dark">Gastos</h3>
                        <p class="text-[10px] text-text-muted-light dark:text-text-muted-dark mt-1 opacity-70 leading-tight truncate">
                            Control de salidas mensuales.
                        </p>
                    </div>
                    <div class="text-sm font-black text-danger mt-2 truncate" id="menuExpenseSummary">$0</div>
                </button>

                <button onclick="navigateTo('health')" class="col-span-2 bg-gradient-to-br from-surface-light to-[#f8f8f8] dark:from-surface-dark dark:to-[#1a1a1a] p-5 rounded-3xl border border-gray-100 dark:border-white/5 shadow-soft hover:shadow-lg transition-all active:scale-[0.98] text-left relative overflow-hidden">
                    <div class="flex justify-between items-center relative z-10">
                        <div class="flex items-center gap-4">
                            <div class="w-10 h-10 rounded-xl bg-amber-500/10 flex items-center justify-center text-warning shrink-0">
                                <span class="material-symbols-rounded text-2xl">equalizer</span>
                            </div>
                            <div>
                                <h3 class="font-bold text-base text-text-main-light dark:text-text-main-dark">Diagnóstico</h3>
                                <p class="text-[10px] text-text-muted-light dark:text-text-muted-dark opacity-80">
                                    Analiza la salud de tus finanzas.
                                </p>
                            </div>
                        </div>
                        <div id="menuHealthBadge" class="px-3 py-1.5 bg-surface-light dark:bg-white/5 border border-gray-200 dark:border-white/10 rounded-full text-[10px] font-black uppercase text-text-muted-light dark:text-white min-w-[70px] text-center shadow-sm">--</div>
                    </div>
                </button>
            </div>

            <div class="bg-surface-light dark:bg-surface-dark p-6 rounded-3xl border border-gray-100 dark:border-white/5 shadow-soft relative overflow-hidden">
                <div class="flex justify-between items-start mb-6">
                    <div>
                        <h3 class="font-bold text-sm uppercase tracking-wider text-text-muted-light dark:text-text-muted-dark">Evolución de Fondos</h3>
                        <p class="text-[10px] text-text-muted-light/60 dark:text-text-muted-dark/60 mt-1">
                            Visualiza cómo crece o disminuye tu capital con el tiempo.
                        </p>
                    </div>
                    <span class="text-[9px] bg-primary/10 text-primary px-2.5 py-1 rounded-lg font-bold border border-primary/20">Histórico</span>
                </div>
                <div class="h-48 relative w-full">
                    <canvas id="overviewChart"></canvas>
                </div>
            </div>
            
            <p class="text-center text-[9px] text-text-muted-light/40 dark:text-text-muted-dark/40 mt-8 mb-4 tracking-widest font-mono">MARIE FINANCE v5.0</p>
        </div>

        <div id="view-goal" class="view-section">
            <div class="text-center mb-8">
                <p class="text-[10px] text-text-muted-light dark:text-text-muted-dark uppercase font-bold tracking-widest mb-1">Monto Objetivo</p>
                <p class="text-[9px] text-text-muted-light/60 dark:text-text-muted-dark/60 mb-2">Define la cantidad total que necesitas reunir</p>
                
                <div class="relative inline-flex items-center justify-center gap-1 group">
                    <span class="text-2xl text-gray-300 dark:text-gray-600 font-light">$</span>
                    <input id="goalInput" type="number" value="5000" class="w-40 bg-transparent text-center text-5xl font-black text-text-main-light dark:text-text-main-dark border-none focus:ring-0 p-0 tracking-tighter placeholder-gray-300 outline-none"/>
                </div>
                
                <div class="bg-surface-light dark:bg-surface-dark rounded-3xl p-5 mt-6 border border-gray-100 dark:border-white/5 shadow-soft transition-all">
                    <div class="flex justify-between items-end mb-4 pb-2 border-b border-gray-100 dark:border-white/5">
                        <div>
                            <span class="text-[10px] font-bold text-text-muted-light dark:text-text-muted-dark uppercase tracking-wide block">Fondo Acumulado</span>
                            <span class="text-[9px] text-text-muted-light/60 dark:text-text-muted-dark/60">Dinero disponible hoy</span>
                        </div>
                        <span id="savedTotalDisplay" class="text-xl font-black text-success">$0</span>
                    </div>
                    
                    <div class="flex gap-3 items-center mb-2">
                        <button onclick="openTransactionModal('withdraw')" class="h-12 w-14 flex items-center justify-center bg-red-50 dark:bg-red-500/10 text-danger rounded-2xl active:bg-red-100 transition-colors border border-transparent"><span class="material-symbols-rounded">remove</span></button>
                        <input id="depositInput" type="number" placeholder="0" class="flex-1 h-12 bg-bg-light dark:bg-bg-dark rounded-2xl border-none text-center text-lg font-bold focus:ring-2 focus:ring-primary/50 outline-none placeholder-gray-300/50">
                        <button onclick="openTransactionModal('deposit')" class="h-12 w-14 flex items-center justify-center bg-emerald-50 dark:bg-emerald-500/10 text-success rounded-2xl active:bg-emerald-100 transition-colors border border-transparent"><span class="material-symbols-rounded">add</span></button>
                    </div>
                    <p class="text-[9px] text-text-muted-light/50 dark:text-text-muted-dark/50 text-center mb-4">Ingresa el monto y pulsa (+) para sumar o (-) para restar</p>

                    <button onclick="toggleHistory()" class="w-full flex items-center justify-center gap-2 py-3 text-[10px] text-text-muted-light/70 uppercase font-bold hover:text-primary transition-colors border-t border-dashed border-gray-200 dark:border-white/10 rounded-b-xl hover:bg-gray-50 dark:hover:bg-white/5">
                        <span>Ver Historial de Movimientos</span>
                        <span id="historyChevron" class="material-symbols-rounded text-base transition-transform duration-300">expand_more</span>
                    </button>
                    
                    <div id="historyContainer" class="hidden pt-2 mt-1 animate-fadeIn">
                        <div class="flex justify-between items-center mb-2 px-1">
                            <span class="text-[9px] text-text-muted-light">Últimos registros</span>
                            <select id="itemsPerPage" onchange="changeItemsPerPage()" class="bg-transparent text-[9px] border-none p-0 text-text-muted-light focus:ring-0 cursor-pointer text-right">
                                <option value="15">15 por pág</option>
                                <option value="30">30 por pág</option>
                            </select>
                        </div>
                        <div id="historyList" class="space-y-2 max-h-60 overflow-y-auto pr-1 text-sm scrollbar-thin"></div>
                        <div id="paginationControls" class="flex justify-center mt-3 pt-2 border-t border-gray-100 dark:border-white/5 hidden">
                            <button onclick="changePage(-1)" class="text-[10px] text-primary disabled:opacity-30 mx-2">Anterior</button>
                            <span id="pageIndicator" class="text-[9px] text-gray-400 mx-2">1 / 1</span>
                            <button onclick="changePage(1)" class="text-[10px] text-primary disabled:opacity-30 mx-2">Siguiente</button>
                        </div>
                    </div>
                </div>
                
                <div class="mt-6 flex flex-col items-center">
                    <span class="text-[9px] font-bold text-text-muted-light dark:text-text-muted-dark uppercase tracking-widest bg-gray-100 dark:bg-white/5 px-3 py-1 rounded-full mb-1">Faltante Real</span>
                    <p class="text-[10px] text-text-muted-light/60 dark:text-text-muted-dark/60 mb-1">Lo que te falta para llegar a la meta</p>
                    <p id="remainingGoalDisplay" class="text-2xl font-black text-text-main-light dark:text-text-main-dark">--</p>
                </div>
            </div>
        </div>

        <div id="view-health" class="view-section">
            <div class="bg-surface-light dark:bg-surface-dark rounded-3xl p-6 mb-6 border border-gray-100 dark:border-white/5 shadow-soft relative overflow-hidden h-72 flex flex-col justify-center">
                <div class="flex justify-between items-center mb-8 relative z-10">
                    <div>
                        <span class="text-lg font-bold text-text-main-light dark:text-white block">Diagnóstico</span>
                        <span class="text-[10px] text-text-muted-light dark:text-white/60">Análisis de flujo de caja</span>
                    </div>
                    <span id="healthLabel" class="text-xs font-black px-4 py-1.5 rounded-full bg-gray-100 dark:bg-white/10 text-text-main-light dark:text-white uppercase tracking-wide">--</span>
                </div>
                <div class="h-8 w-full bg-gray-200 dark:bg-black/50 rounded-full overflow-hidden relative shadow-inner z-10">
                    <div class="absolute inset-0 bg-gradient-to-r from-danger via-warning to-success opacity-90"></div>
                    <div id="healthIndicator" class="absolute top-0 bottom-0 w-2.5 bg-white shadow-[0_0_20px_rgba(255,255,255,1)] ring-4 ring-black/10 transition-all duration-700 ease-out" style="left: 50%"></div>
                </div>
                <div class="flex justify-between text-[10px] text-text-muted-light dark:text-gray-500 mt-4 font-mono uppercase relative z-10 font-bold px-1">
                    <span>Riesgo</span>
                    <span>Equilibrio</span>
                    <span>Solidez</span>
                </div>
                <div class="mt-10 p-4 bg-bg-light dark:bg-bg-dark rounded-2xl text-center border border-gray-100 dark:border-white/5">
                    <p class="text-xs text-text-muted-light dark:text-text-muted-dark leading-relaxed" id="healthTextDesc">Analizando...</p>
                </div>
            </div>
        </div>

        <div id="view-expenses" class="view-section">
            <div class="bg-surface-light dark:bg-surface-dark rounded-3xl p-6 mb-6 border border-gray-100 dark:border-white/5 shadow-soft">
                <div class="text-center py-8 border-b border-dashed border-gray-200 dark:border-white/10 mb-6">
                    <span class="text-[9px] font-bold text-danger/80 uppercase tracking-[0.25em] block mb-1">Total Egresos Mensual</span>
                    <p class="text-[9px] text-text-muted-light dark:text-text-muted-dark mb-1">Suma de todos tus compromisos fijos y variables</p>
                    <p id="totalExpensesDisplay" class="text-6xl font-black text-danger tracking-tighter mt-2">$0</p>
                </div>
                <div class="flex justify-between items-center mb-5">
                    <span class="text-xs font-bold text-text-muted-light">Desglose de Gastos</span>
                    <button onclick="addExpense()" class="text-[10px] bg-bg-light dark:bg-bg-dark border border-gray-200 dark:border-white/10 px-4 py-1.5 rounded-xl hover:text-primary transition-colors flex items-center gap-1 font-bold">
                        <span class="material-symbols-rounded text-sm">add</span> Nuevo
                    </button>
                </div>
                <div id="expensesList" class="space-y-3"></div>
            </div>
        </div>

        <div id="view-incomes" class="view-section">
            <div class="bg-surface-light dark:bg-surface-dark rounded-3xl p-6 border border-gray-100 dark:border-white/5 shadow-soft mb-6">
                <div class="flex justify-between items-center mb-6 border-b border-gray-100 dark:border-white/5 pb-6">
                    <div>
                        <span class="text-[9px] font-bold text-success/80 uppercase tracking-[0.25em] block mb-1">Total Ingresos</span>
                        <p class="text-[9px] text-text-muted-light dark:text-text-muted-dark mb-1">Sueldo fijo + Ganancias de ventas</p>
                        <p id="totalIncomeDisplay" class="text-4xl font-black text-success tracking-tighter mt-1">$0</p>
                    </div>
                    <button onclick="addIncomeItem()" class="h-12 w-12 rounded-full bg-emerald-50 dark:bg-emerald-500/10 text-emerald-600 flex items-center justify-center active:scale-95 transition-transform shadow-sm">
                        <span class="material-symbols-rounded text-2xl">add</span>
                    </button>
                </div>
                <div class="space-y-6">
                    <div class="flex items-center justify-between border-b border-dashed border-gray-200 dark:border-white/10 pb-4">
                        <div>
                            <label class="text-[11px] text-text-muted-light dark:text-text-muted-dark font-bold uppercase block">Sueldo Fijo</label>
                            <p class="text-[9px] text-text-muted-light/60 dark:text-text-muted-dark/60">Monto base mensual</p>
                        </div>
                        <div class="flex items-center bg-bg-light dark:bg-bg-dark px-4 py-2 rounded-xl">
                            <span class="text-text-muted-light dark:text-text-muted-dark mr-1 text-xs">$</span>
                            <input id="salaryInput" type="number" class="w-20 bg-transparent text-right font-bold text-base text-text-main-light dark:text-text-main-dark border-none focus:ring-0 p-0 outline-none" value="600">
                        </div>
                    </div>
                    <div id="incomeList" class="space-y-4"></div>
                    <p class="text-center text-[9px] text-text-muted-light/50 dark:text-text-muted-dark/50 italic mt-4">
                        Nota: La ganancia se calcula automáticamente: (Precio - Costo) x Cantidad.
                    </p>
                </div>
            </div>
        </div>

    </div>

    <div id="transactionModal" class="fixed inset-0 z-[60] hidden flex items-center justify-center px-4">
        <div onclick="closeTransactionModal()" class="absolute inset-0 bg-black/60 backdrop-blur-sm transition-opacity"></div>
        <div class="bg-surface-light dark:bg-[#1f1a1a] w-full max-w-sm rounded-3xl p-6 shadow-2xl relative z-10 transform transition-all scale-95 opacity-0" id="transactionCard">
            <h3 class="text-lg font-bold text-center mb-1 text-text-main-light dark:text-text-main-dark" id="modalTitle">Nuevo Depósito</h3>
            <p class="text-[10px] text-center text-gray-400 mb-6 uppercase tracking-widest font-mono" id="modalAmountDisplay">$0.00</p>
            <div class="mb-5">
                <label class="text-[10px] font-bold text-text-muted-light dark:text-text-muted-dark uppercase block mb-2 pl-1">Concepto / Detalle</label>
                <input id="transactionDesc" type="text" placeholder="Ej: Ahorro semana..." class="w-full bg-bg-light dark:bg-bg-dark rounded-xl border-none py-3 px-4 text-sm focus:ring-2 focus:ring-primary outline-none text-text-main-light dark:text-white placeholder-gray-400">
            </div>
            <div class="grid grid-cols-2 gap-3">
                <button onclick="closeTransactionModal()" class="py-3 rounded-xl text-xs font-bold bg-gray-100 dark:bg-white/5 text-text-muted-light hover:bg-gray-200 dark:hover:bg-white/10 transition-colors">Cancelar</button>
                <button onclick="confirmTransaction()" id="modalConfirmBtn" class="py-3 rounded-xl text-xs font-bold bg-primary text-white shadow-lg shadow-primary/30 active:scale-95 transition-transform">Guardar</button>
            </div>
        </div>
    </div>

    <div id="persistentResults" class="fixed bottom-0 w-full z-40 p-4 glass-sheet rounded-t-[2rem] shadow-[0_-5px_40px_rgba(0,0,0,0.15)] transition-transform duration-300">
        <div id="statusGlow" class="absolute bottom-0 right-0 w-full h-full bg-success/5 blur-3xl pointer-events-none transition-colors duration-700"></div>
        <div class="max-w-md mx-auto relative z-10 px-1">
            <div class="flex justify-between items-start mb-4">
                <div>
                    <p class="text-[10px] font-bold text-text-muted-light dark:text-text-muted-dark uppercase tracking-widest mb-0.5">Capacidad Mensual</p>
                    <p class="text-[9px] text-text-muted-light/60 dark:text-text-muted-dark/60 mb-1">Dinero sobrante para invertir</p>
                    <h2 id="monthlySurplusDisplay" class="text-3xl font-black text-text-main-light dark:text-text-main-dark tracking-tight">$0</h2>
                </div>
                <div class="text-right">
                    <p class="text-[9px] text-text-muted-light dark:text-text-muted-dark mb-1">Tiempo Estimado</p>
                    <div id="timeBadge" class="inline-flex items-center gap-1 bg-bg-light dark:bg-bg-dark px-3 py-1.5 rounded-full border border-gray-200 dark:border-white/10 shadow-sm">
                        <span class="material-symbols-rounded text-xs text-primary">timer</span>
                        <span id="timeToGoalDisplay" class="text-xs font-bold text-text-main-light dark:text-text-main-dark">--</span>
                    </div>
                </div>
            </div>
            <div class="w-full bg-gray-200 dark:bg-black/30 h-1.5 rounded-full overflow-hidden">
                <div id="progressBar" class="h-full bg-slate-800 dark:bg-white w-0 transition-all duration-1000 rounded-full"></div>
            </div>
            <div class="flex justify-between text-[10px] text-text-muted-light dark:text-text-muted-dark mt-2 font-medium">
                <span>Velocidad de Ahorro</span>
                <span id="progressText">Meta: $5k</span>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const els = {
                sections: document.querySelectorAll('.view-section'),
                pageTitleLabel: document.getElementById('pageTitleLabel'),
                pageTitleMain: document.getElementById('pageTitleMain'),
                backBtn: document.getElementById('backBtn'),
                menuGoal: document.getElementById('menuGoalSummary'),
                menuIncome: document.getElementById('menuIncomeSummary'),
                menuExpense: document.getElementById('menuExpenseSummary'),
                menuHealth: document.getElementById('menuHealthBadge'),
                goal: document.getElementById('goalInput'),
                savedTotal: document.getElementById('savedTotalDisplay'),
                depositInput: document.getElementById('depositInput'),
                remainingGoalDisplay: document.getElementById('remainingGoalDisplay'),
                salary: document.getElementById('salaryInput'),
                incomeList: document.getElementById('incomeList'),
                totalIncome: document.getElementById('totalIncomeDisplay'),
                expensesList: document.getElementById('expensesList'),
                totalExpenses: document.getElementById('totalExpensesDisplay'),
                surplus: document.getElementById('monthlySurplusDisplay'),
                timeBadge: document.getElementById('timeToGoalDisplay'),
                progressBar: document.getElementById('progressBar'),
                progressText: document.getElementById('progressText'),
                healthIndicator: document.getElementById('healthIndicator'),
                healthLabel: document.getElementById('healthLabel'),
                healthDesc: document.getElementById('healthTextDesc'),
                statusGlow: document.getElementById('statusGlow'),
                historyContainer: document.getElementById('historyContainer'),
                historyChevron: document.getElementById('historyChevron'),
                historyList: document.getElementById('historyList'),
                itemsPerPage: document.getElementById('itemsPerPage'),
                paginationControls: document.getElementById('paginationControls'),
                pageIndicator: document.getElementById('pageIndicator'),
                modal: document.getElementById('transactionModal'),
                modalCard: document.getElementById('transactionCard'),
                modalTitle: document.getElementById('modalTitle'),
                modalAmount: document.getElementById('modalAmountDisplay'),
                modalDesc: document.getElementById('transactionDesc'),
                modalBtn: document.getElementById('modalConfirmBtn')
            };

            let state = {
                goal: 5000,
                accumulatedSaved: 0, 
                salary: 600,
                incomes: [{ id: 'def1', name: 'Servicio A', price: 150, cost: 10, qty: 10 }],
                expenses: [
                    { id: 'exp1', name: 'Vivienda', amount: 350, color: '#e15b64' },
                    { id: 'exp2', name: 'Comida', amount: 250, color: '#f59e0b' }
                ],
                history: [],
                pagination: { page: 1, limit: 15 },
                darkMode: true
            };

            let chartInstance = null;
            let pendingTransaction = null;
            const STORAGE_KEY = 'marieFinance_v24_info';

            // --- NAVEGACIÓN ---
            window.navigateTo = (viewId) => {
                els.sections.forEach(s => s.classList.remove('active'));
                document.getElementById(`view-${viewId}`).classList.add('active');

                if(viewId === 'home') {
                    els.backBtn.classList.add('hidden');
                    els.pageTitleLabel.textContent = "MENÚ";
                    els.pageTitleMain.innerHTML = 'Marie<span class="text-primary">.App</span>';
                    updateMenuSummaries();
                    updateChart();
                } else {
                    els.backBtn.classList.remove('hidden');
                    const titles = { 'goal': 'Objetivo', 'health': 'Diagnóstico', 'expenses': 'Gastos', 'incomes': 'Ingresos' };
                    els.pageTitleLabel.textContent = "SECCIÓN";
                    els.pageTitleMain.textContent = titles[viewId] || viewId;
                }
            };

            function updateMenuSummaries() {
                els.menuGoal.textContent = formatCompact(state.goal);
                
                let incomeTotal = state.salary;
                state.incomes.forEach(i => incomeTotal += (i.price - i.cost) * i.qty);
                els.menuIncome.textContent = formatMoney(incomeTotal);
                
                let expTotal = state.expenses.reduce((a, b) => a + (parseFloat(b.amount)||0), 0);
                els.menuExpense.textContent = formatMoney(expTotal);
                
                const ratio = expTotal > 0 ? incomeTotal / expTotal : 0;
                if(ratio >= 1.2) els.menuHealth.textContent = "Sólida";
                else if (ratio >= 1) els.menuHealth.textContent = "Estable";
                else els.menuHealth.textContent = "Riesgo";
            }

            // --- CHART ---
            function updateChart() {
                const ctx = document.getElementById('overviewChart').getContext('2d');
                const sortedHistory = [...state.history].sort((a, b) => a.id - b.id);
                let currentBalance = 0;
                const dataPoints = [];
                
                if(sortedHistory.length > 0) dataPoints.push({ x: sortedHistory[0].id - 86400000, y: 0 });

                sortedHistory.forEach(h => {
                    const change = h.type === 'deposit' ? h.amount : -h.amount;
                    currentBalance = Math.max(0, currentBalance + change);
                    dataPoints.push({ x: h.id, y: currentBalance });
                });

                if (dataPoints.length === 0) dataPoints.push({ x: Date.now(), y: state.accumulatedSaved });

                if(chartInstance) chartInstance.destroy();

                const gradient = ctx.createLinearGradient(0, 0, 0, 300);
                gradient.addColorStop(0, 'rgba(212, 141, 158, 0.4)'); 
                gradient.addColorStop(1, 'rgba(212, 141, 158, 0.0)');

                chartInstance = new Chart(ctx, {
                    type: 'line',
                    data: {
                        datasets: [{
                            label: 'Fondo',
                            data: dataPoints,
                            borderColor: '#d48d9e',
                            backgroundColor: gradient,
                            borderWidth: 2,
                            pointRadius: 0,
                            pointHoverRadius: 4,
                            fill: true,
                            tension: 0.4
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: { legend: { display: false }, tooltip: { mode: 'index', intersect: false } },
                        scales: {
                            x: {
                                type: 'time',
                                time: { unit: 'day', displayFormats: { day: 'd MMM' } },
                                grid: { display: false },
                                ticks: { color: state.darkMode ? '#888' : '#666', font: {size: 9}, maxTicksLimit: 5 }
                            },
                            y: { display: false, min: 0 }
                        },
                        interaction: { mode: 'nearest', axis: 'x', intersect: false }
                    }
                });
            }

            // --- CORE ---
            function calculate() {
                state.goal = parseFloat(els.goal.value) || 0;
                state.salary = parseFloat(els.salary.value) || 0;

                els.savedTotal.textContent = formatMoney(state.accumulatedSaved);
                const remainingGoal = Math.max(0, state.goal - state.accumulatedSaved);
                els.remainingGoalDisplay.textContent = formatMoney(remainingGoal);

                let dynamicIncomeTotal = 0;
                state.incomes.forEach(inc => {
                    const margin = (inc.price - inc.cost);
                    const subtotal = margin * inc.qty;
                    dynamicIncomeTotal += subtotal;
                    const subEl = document.getElementById(`subtotal-${inc.id}`);
                    const qtyEl = document.getElementById(`qty-label-${inc.id}`);
                    if(subEl) subEl.textContent = `+${formatMoney(subtotal)}`;
                    if(qtyEl) qtyEl.textContent = inc.qty;
                });
                
                const totalIncomeVal = state.salary + dynamicIncomeTotal;
                const totalExpensesVal = state.expenses.reduce((acc, curr) => acc + (parseFloat(curr.amount) || 0), 0);
                const surplusVal = totalIncomeVal - totalExpensesVal;

                animateValue(els.totalIncome, totalIncomeVal);
                animateValue(els.totalExpenses, totalExpensesVal);
                els.progressText.textContent = `Faltan: ${formatCompact(remainingGoal)}`;

                const prefix = surplusVal > 0 ? '+' : '';
                els.surplus.textContent = prefix + formatMoney(surplusVal);
                
                if (surplusVal > 0) {
                    els.surplus.className = "text-3xl font-black text-success tracking-tight mt-1 transition-colors";
                    const months = remainingGoal / surplusVal;
                    els.timeBadge.textContent = remainingGoal <= 0 ? "¡Listo!" : (months < 1 ? "Días" : `${months.toFixed(1)} Meses`);
                    els.progressBar.style.width = Math.min((surplusVal/totalIncomeVal)*100*2.5, 100) + "%";
                    els.progressBar.className = "h-full bg-success w-0 transition-all duration-1000 rounded-full";
                } else {
                    els.surplus.className = "text-3xl font-black text-danger tracking-tight mt-1 transition-colors";
                    els.timeBadge.textContent = "Infinito";
                    els.progressBar.style.width = "100%";
                    els.progressBar.className = "h-full bg-danger w-0 transition-all duration-1000 rounded-full";
                }

                let healthRatio = totalIncomeVal > 0 ? (totalExpensesVal > 0 ? totalIncomeVal/totalExpensesVal : 2) : 0;
                let sliderVal = healthRatio >= 1 ? 50 + ((healthRatio - 1) * 50) : healthRatio * 50;
                sliderVal = Math.min(Math.max(sliderVal, 0), 100);
                if(els.healthIndicator) els.healthIndicator.style.left = `${sliderVal}%`;
                
                if (sliderVal < 45) {
                    if(els.healthLabel) { els.healthLabel.textContent = "RIESGO"; els.healthLabel.className = "text-[9px] font-black px-2 py-1 rounded bg-danger text-white uppercase"; }
                    if(els.healthDesc) els.healthDesc.textContent = "Tus gastos superan peligrosamente tus ingresos. Reduce costos innecesarios.";
                } else if (sliderVal < 60) {
                    if(els.healthLabel) { els.healthLabel.textContent = "EQUILIBRIO"; els.healthLabel.className = "text-[9px] font-black px-2 py-1 rounded bg-warning text-white uppercase"; }
                    if(els.healthDesc) els.healthDesc.textContent = "Tus ingresos cubren tus gastos, pero tienes poco margen para ahorrar.";
                } else {
                    if(els.healthLabel) { els.healthLabel.textContent = "SOLIDEZ"; els.healthLabel.className = "text-[9px] font-black px-2 py-1 rounded bg-success text-white uppercase"; }
                    if(els.healthDesc) els.healthDesc.textContent = "Tu salud financiera es excelente. Tienes capacidad de ahorro e inversión.";
                }
                saveState();
            }

            // --- HISTORY ---
            window.openTransactionModal = (type) => {
                const amount = parseFloat(els.depositInput.value);
                if (!amount || amount <= 0) return alert("Ingresa un monto válido");
                pendingTransaction = { type, amount };
                els.modalTitle.textContent = type === 'deposit' ? 'Confirmar Ingreso' : 'Confirmar Retiro';
                els.modalAmount.textContent = formatMoney(amount);
                els.modalBtn.className = `py-3 rounded-xl text-xs font-bold text-white shadow-lg ${type === 'deposit' ? 'bg-success shadow-success/30' : 'bg-danger shadow-danger/30'}`;
                els.modalDesc.value = "";
                els.modal.classList.remove('hidden');
                setTimeout(() => { els.modalCard.classList.remove('scale-95', 'opacity-0'); els.modalCard.classList.add('scale-100', 'opacity-100'); }, 10);
            };

            window.closeTransactionModal = () => {
                els.modalCard.classList.remove('scale-100', 'opacity-100');
                els.modalCard.classList.add('scale-95', 'opacity-0');
                setTimeout(() => els.modal.classList.add('hidden'), 200);
            };

            window.confirmTransaction = () => {
                if (!pendingTransaction) return;
                const desc = els.modalDesc.value.trim() || (pendingTransaction.type === 'deposit' ? 'Depósito Manual' : 'Retiro Manual');
                if (pendingTransaction.type === 'deposit') {
                    state.accumulatedSaved += pendingTransaction.amount;
                    triggerConfetti();
                } else {
                    state.accumulatedSaved = Math.max(0, state.accumulatedSaved - pendingTransaction.amount);
                }
                state.history.unshift({ id: Date.now(), date: new Date().toISOString(), type: pendingTransaction.type, amount: pendingTransaction.amount, desc: desc });
                els.depositInput.value = '';
                calculate();
                renderHistory();
                updateChart(); 
                closeTransactionModal();
            };

            window.toggleHistory = () => {
                els.historyContainer.classList.toggle('hidden');
                els.historyChevron.classList.toggle('rotate-180');
                renderHistory();
            };

            window.changeItemsPerPage = () => { state.pagination.limit = parseInt(els.itemsPerPage.value); state.pagination.page = 1; renderHistory(); };
            window.changePage = (dir) => { state.pagination.page += dir; renderHistory(); };

            function renderHistory() {
                const start = (state.pagination.page - 1) * state.pagination.limit;
                const end = start + state.pagination.limit;
                const pageItems = state.history.slice(start, end);
                const totalPages = Math.ceil(state.history.length / state.pagination.limit);

                els.historyList.innerHTML = '';
                if (state.history.length === 0) {
                    els.historyList.innerHTML = '<p class="text-center text-[10px] text-gray-400 py-4 italic">Sin movimientos</p>';
                    els.paginationControls.classList.add('hidden');
                    return;
                }

                pageItems.forEach(item => {
                    const isDeposit = item.type === 'deposit';
                    els.historyList.innerHTML += `
                        <div class="flex justify-between items-center py-2 border-b border-gray-100 dark:border-white/5 last:border-0">
                            <div class="flex items-center gap-3">
                                <div class="w-8 h-8 rounded-full flex items-center justify-center ${isDeposit ? 'bg-emerald-500/10 text-success' : 'bg-red-500/10 text-danger'}">
                                    <span class="material-symbols-rounded text-sm">${isDeposit ? 'arrow_downward' : 'arrow_upward'}</span>
                                </div>
                                <div>
                                    <p class="font-bold text-text-main-light dark:text-text-main-dark">${item.desc}</p>
                                    <p class="text-[10px] text-text-muted-light">${new Date(item.date).toLocaleDateString()}</p>
                                </div>
                            </div>
                            <span class="font-bold font-mono ${isDeposit ? 'text-success' : 'text-danger'}">
                                ${isDeposit ? '+' : '-'}${formatMoney(item.amount)}
                            </span>
                        </div>
                    `;
                });

                if (totalPages > 1) {
                    els.paginationControls.classList.remove('hidden');
                    els.pageIndicator.textContent = `${state.pagination.page} / ${totalPages}`;
                    els.paginationControls.children[0].disabled = state.pagination.page === 1;
                    els.paginationControls.children[2].disabled = state.pagination.page === totalPages;
                } else {
                    els.paginationControls.classList.add('hidden');
                }
            }

            // --- UTILS ---
            function loadState() {
                const saved = localStorage.getItem(STORAGE_KEY);
                if(saved) {
                    try { state = { ...state, ...JSON.parse(saved) }; if(!state.history) state.history=[]; } catch(e) {}
                }
                els.goal.value = state.goal;
                els.salary.value = state.salary;
                if(state.darkMode) document.documentElement.classList.add('dark');
                else document.documentElement.classList.remove('dark');
            }
            function saveState() {
                state.darkMode = document.documentElement.classList.contains('dark');
                localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
            }
            window.addIncomeItem = () => { state.incomes.push({ id: Date.now(), name: 'Nuevo', price: 0, cost: 0, qty: 1 }); renderIncomes(); calculate(); };
            window.removeIncome = (id) => { state.incomes = state.incomes.filter(i => i.id != id); renderIncomes(); calculate(); };
            window.updateIncome = (id, f, v) => { const idx = state.incomes.findIndex(i => i.id == id); if(idx > -1) { state.incomes[idx][f] = f === 'name' ? v : parseFloat(v)||0; calculate(); } };
            window.addExpense = () => { state.expenses.push({ id: Date.now(), name: 'Nuevo', amount: 0, color: '#e15b64' }); renderExpenses(); calculate(); };
            window.removeExpense = (id) => { state.expenses = state.expenses.filter(e => e.id != id); renderExpenses(); calculate(); };
            window.updateExp = (id, f, v) => { const idx = state.expenses.findIndex(e => e.id == id); if(idx > -1) { state.expenses[idx][f] = f === 'name' ? v : parseFloat(v)||0; calculate(); } };
            window.resetAllData = () => { if(confirm("¿Borrar todo?")) { localStorage.removeItem(STORAGE_KEY); location.reload(); }};
            function triggerConfetti() { confetti({ particleCount: 100, spread: 70, origin: { y: 0.6 } }); }
            const formatMoney = (v) => new Intl.NumberFormat('en-US', { style: 'currency', currency: 'USD', maximumFractionDigits: 0 }).format(v);
            const formatCompact = (v) => new Intl.NumberFormat('en-US', { notation: "compact", maximumFractionDigits: 1 }).format(v);
            function animateValue(obj, end) { obj.textContent = formatMoney(end); }

            function renderIncomes() {
                els.incomeList.innerHTML = '';
                state.incomes.forEach(inc => {
                    const margin = inc.price - inc.cost;
                    const subtotal = margin * inc.qty;
                    els.incomeList.innerHTML += `
                    <div class="bg-surface-light dark:bg-black/20 p-4 rounded-xl border border-gray-100 dark:border-white/5 mb-3">
                        <div class="flex justify-between items-center mb-2">
                            <input value="${inc.name}" class="bg-transparent text-sm font-bold w-full border-none p-0 focus:ring-0 outline-none" oninput="updateIncome('${inc.id}', 'name', this.value)">
                            <button onclick="removeIncome('${inc.id}')" class="text-text-muted-light hover:text-danger material-symbols-rounded text-sm">close</button>
                        </div>
                        <div class="flex gap-2 mb-2">
                            <input type="number" value="${inc.price}" class="w-1/2 bg-bg-light dark:bg-bg-dark rounded-lg py-2 px-3 text-xs border-none" oninput="updateIncome('${inc.id}', 'price', this.value)">
                            <input type="number" value="${inc.cost}" class="w-1/2 bg-bg-light dark:bg-bg-dark rounded-lg py-2 px-3 text-xs border-none text-danger" oninput="updateIncome('${inc.id}', 'cost', this.value)">
                        </div>
                        <div class="flex items-center gap-2 mb-2">
                            <input type="range" min="0" max="200" value="${inc.qty}" class="flex-1" oninput="updateIncome('${inc.id}', 'qty', this.value)">
                            <span id="qty-label-${inc.id}" class="text-xs font-bold bg-primary/10 px-2 rounded">${inc.qty}</span>
                        </div>
                        <div class="text-right text-xs font-bold text-success" id="subtotal-${inc.id}">+${formatMoney(subtotal)}</div>
                    </div>`;
                });
            }

            function renderExpenses() {
                els.expensesList.innerHTML = '';
                state.expenses.forEach(exp => {
                    els.expensesList.innerHTML += `
                    <div class="flex items-center justify-between p-3 rounded-xl bg-surface-light dark:bg-transparent border border-gray-100 dark:border-white/5 mb-2">
                        <input value="${exp.name}" class="bg-transparent text-sm font-bold w-full border-none p-0 focus:ring-0 outline-none" oninput="updateExp('${exp.id}', 'name', this.value)">
                        <div class="flex items-center gap-2">
                            <span class="text-xs text-text-muted-light">$</span>
                            <input type="number" value="${exp.amount}" class="bg-transparent text-right font-bold w-20 border-none p-0 focus:ring-0 outline-none" oninput="updateExp('${exp.id}', 'amount', this.value)">
                            <button onclick="removeExpense('${exp.id}')" class="text-text-muted-light hover:text-danger material-symbols-rounded text-sm">close</button>
                        </div>
                    </div>`;
                });
            }

            // Init
            els.goal.addEventListener('input', calculate);
            els.salary.addEventListener('input', calculate);
            document.getElementById('themeToggle').addEventListener('click', () => { document.documentElement.classList.toggle('dark'); saveState(); updateChart(); });
            
            loadState();
            renderIncomes();
            renderExpenses();
            calculate();
            updateMenuSummaries();
            updateChart();
        });
    </script>
</body>
</html>
