<!DOCTYPE html>
<html class="dark" lang="es">
<head>
    <meta charset="utf-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover"/>
    <title>Marie Finance - Aurea Mobile</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&family=Inter:wght@300;400;500;600&display=swap" rel="stylesheet"/>
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Rounded:opsz,wght,FILL,GRAD@24,400,1,0" rel="stylesheet" />
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js/dist/chart.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>

    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>

    <script id="tailwind-config">
        tailwind.config = {
            darkMode: "class",
            theme: {
                extend: {
                    colors: {
                        "primary": "#b08968",        
                        "bg-dark": "#0c0a09",
                        "card-dark": "#1c1917",
                        "text-main-light": "#4a403a",
                        "text-muted-light": "#9c8c84",
                        "text-main-dark": "#e7e5e4",
                        "text-muted-dark": "#a8a29e",
                        "success": "#6a994e",        
                        "danger": "#bc4749",        
                        "warning": "#e9c46a",        
                    },
                    fontFamily: {
                        "display": ["Plus Jakarta Sans", "sans-serif"],
                        "body": ["Inter", "sans-serif"],
                    },
                    boxShadow: {
                        'soft': '0 10px 40px -10px rgba(0, 0, 0, 0.08)',
                        'glow': '0 0 20px -5px rgba(176, 137, 104, 0.3)',
                    }
                },
            },
        }
    </script>

    <style>
        /* BASE */
        body { -webkit-tap-highlight-color: transparent; overscroll-behavior-y: none; }
        input:focus { outline: none; }
        input[type=number]::-webkit-inner-spin-button { -webkit-appearance: none; margin: 0; }
        
        /* ANIMACIONES */
        .fade-in { animation: fadeIn 0.4s cubic-bezier(0.2, 0.8, 0.2, 1) forwards; opacity: 0; transform: translateY(10px); }
        @keyframes fadeIn { to { opacity: 1; transform: translateY(0); } }

        /* FONDO */
        .animated-bg {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: -1;
            background: linear-gradient(180deg, #f5f5f4 0%, #e7e5e4 100%);
        }
        .dark .animated-bg {
            background: linear-gradient(180deg, #0c0a09 0%, #1c1917 100%);
        }

        /* GLASSMORPHISM PROLIJO */
        .glass-panel { 
            background: rgba(255, 255, 255, 0.85); 
            backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px);
            border-bottom: 1px solid rgba(0,0,0,0.05);
        }
        .dark .glass-panel { 
            background: rgba(12, 10, 9, 0.85); 
            border-bottom: 1px solid rgba(255,255,255,0.05); 
        }
        
        .card-clean {
            background: rgba(255, 255, 255, 0.7);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.6);
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.02), 0 2px 4px -1px rgba(0, 0, 0, 0.02);
            transition: transform 0.2s;
        }
        .dark .card-clean {
            background: rgba(30, 25, 24, 0.6); 
            border: 1px solid rgba(255, 255, 255, 0.08);
        }
        .card-clean:active { transform: scale(0.98); }

        /* INPUT EDITABLE INDICATOR */
        .input-editable-container { position: relative; display: flex; align-items: center; }
        .input-editable-icon {
            opacity: 0.3; margin-left: 6px; pointer-events: none; transition: opacity 0.2s;
        }
        .input-editable:focus + .input-editable-icon { opacity: 0; }
        .input-editable:focus { border-bottom: 1px solid var(--primary); }

        /* TYPOGRAPHY */
        .text-balance { font-size: clamp(2.5rem, 8vw, 3.5rem); letter-spacing: -0.05em; line-height: 1; }
        
        /* SCROLL */
        ::-webkit-scrollbar { width: 0px; background: transparent; }
        
        /* UTILS */
        #toast {
            visibility: hidden; min-width: 200px; background-color: #1c1917; color: #fff; text-align: center;
            border-radius: 99px; padding: 12px 24px; position: fixed; z-index: 100;
            left: 50%; bottom: 100px; transform: translateX(-50%) translateY(20px);
            font-size: 13px; font-weight: 600; opacity: 0; transition: all 0.3s;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
        }
        #toast.show { visibility: visible; opacity: 1; transform: translateX(-50%) translateY(0); }
    </style>
</head>

<body class="text-text-main-light dark:text-text-main-dark font-body min-h-screen flex flex-col overflow-x-hidden selection:bg-primary/30">

    <div class="animated-bg"></div>
    <div id="toast">Notificación</div>

    <div id="loginOverlay" class="fixed inset-0 z-[999] bg-[#e7e5e4] dark:bg-[#0c0a09] flex items-center justify-center transition-opacity duration-500">
        <div class="w-full max-w-sm px-8 text-center">
            <div class="w-20 h-20 bg-primary/20 rounded-3xl mx-auto mb-6 flex items-center justify-center">
                <span class="material-symbols-rounded text-4xl text-primary">account_balance_wallet</span>
            </div>
            <h1 class="text-3xl font-display font-bold mb-2">Marie Finance</h1>
            <p class="text-sm text-text-muted-light dark:text-text-muted-dark mb-10">Tu economía, prolija y bajo control.</p>
            <button onclick="Auth.login()" class="w-full py-4 rounded-2xl bg-white dark:bg-white/5 font-bold flex items-center justify-center gap-3 shadow-soft active:scale-95 transition-all border border-black/5 dark:border-white/10">
                <img src="https://www.svgrepo.com/show/475656/google-color.svg" class="w-5 h-5" alt="G">
                <span>Entrar con Google</span>
            </button>
        </div>
    </div>

    <div class="fixed top-0 w-full z-50 glass-panel">
        <div class="max-w-md mx-auto px-5 py-3 flex items-center justify-between">
            <div class="flex items-center gap-3" onclick="App.navigateTo('home')">
                <button id="backBtn" class="hidden w-10 h-10 rounded-full bg-black/5 dark:bg-white/5 flex items-center justify-center">
                    <span class="material-symbols-rounded text-lg">arrow_back</span>
                </button>
                <div>
                    <span class="text-[10px] font-black tracking-widest text-primary block">MARIE FINANCE</span>
                    <h2 id="pageTitle" class="text-lg font-bold font-display leading-none">Resumen</h2>
                </div>
            </div>
            <div class="flex gap-2">
                <button onclick="App.toggleTheme()" class="w-10 h-10 rounded-full border border-black/5 dark:border-white/10 flex items-center justify-center active:scale-90 transition-transform">
                    <span class="material-symbols-rounded text-lg">contrast</span>
                </button>
                <button onclick="Auth.logout()" class="w-10 h-10 rounded-full border border-black/5 dark:border-white/10 flex items-center justify-center text-danger/80 active:scale-90 transition-transform">
                    <span class="material-symbols-rounded text-lg">logout</span>
                </button>
            </div>
        </div>
    </div>

    <div class="flex-1 w-full max-w-md mx-auto px-5 pt-28 pb-40" id="mainContainer">
        
        <div id="view-home" class="flex flex-col gap-4">
            
            <div class="card-clean rounded-[2.5rem] p-8 text-center relative overflow-hidden group fade-in" onclick="App.navigateTo('goal')">
                <div class="absolute top-0 left-0 w-full h-1 bg-gradient-to-r from-transparent via-primary to-transparent opacity-50"></div>
                <p class="text-xs font-bold text-text-muted-light dark:text-text-muted-dark uppercase tracking-widest mb-4">Disponible Real</p>
                <div class="flex justify-center items-start gap-1 mb-2">
                    <span class="text-2xl text-text-muted-light/50 mt-1">$</span>
                    <h1 id="homeGoalDisplay" class="text-balance font-black text-text-main-light dark:text-white tracking-tight">0</h1>
                </div>
                <div class="inline-flex items-center gap-2 px-4 py-1.5 bg-success/10 text-success rounded-full text-xs font-bold border border-success/20">
                    <span class="material-symbols-rounded text-sm">trending_up</span>
                    <span id="surplusDisplay">+0 saldo</span>
                </div>
            </div>

            <div class="grid grid-cols-2 gap-4 fade-in" style="animation-delay: 0.1s;">
                <button onclick="App.navigateTo('incomes')" class="card-clean p-5 rounded-3xl flex flex-col gap-3 items-start text-left hover:bg-white/40 dark:hover:bg-white/5 transition-colors group">
                    <div class="w-10 h-10 rounded-full bg-success/10 flex items-center justify-center text-success group-hover:scale-110 transition-transform">
                        <span class="material-symbols-rounded">arrow_downward</span>
                    </div>
                    <div>
                        <span class="text-[10px] font-bold opacity-60 uppercase block">Entradas</span>
                        <span id="homeIncomeDisplay" class="text-xl font-black text-text-main-light dark:text-white">$0</span>
                    </div>
                </button>

                <button onclick="App.navigateTo('expenses')" class="card-clean p-5 rounded-3xl flex flex-col gap-3 items-start text-left hover:bg-white/40 dark:hover:bg-white/5 transition-colors group">
                    <div class="w-10 h-10 rounded-full bg-danger/10 flex items-center justify-center text-danger group-hover:scale-110 transition-transform">
                        <span class="material-symbols-rounded">arrow_upward</span>
                    </div>
                    <div>
                        <span class="text-[10px] font-bold opacity-60 uppercase block">Salidas</span>
                        <span id="homeExpenseDisplay" class="text-xl font-black text-text-main-light dark:text-white">$0</span>
                    </div>
                </button>
            </div>

            <div class="card-clean p-6 rounded-3xl mt-2 fade-in" style="animation-delay: 0.2s;">
                <div class="flex justify-between items-center mb-4">
                    <span class="text-xs font-bold uppercase text-text-muted-light">Salud Financiera</span>
                    <span id="healthBadge" class="text-[10px] font-black px-2 py-0.5 rounded-md bg-black/5 dark:bg-white/10">--</span>
                </div>
                <div class="w-full h-2 bg-black/5 dark:bg-white/5 rounded-full overflow-hidden mb-2">
                    <div id="healthIndicator" class="h-full bg-gradient-to-r from-danger via-warning to-success transition-all duration-1000 w-0"></div>
                </div>
                <p id="healthDesc" class="text-xs opacity-60 leading-relaxed">Analizando tus movimientos...</p>
            </div>

            <div class="card-clean p-6 rounded-3xl fade-in relative" style="animation-delay: 0.3s;">
                <p class="text-xs font-bold uppercase text-text-muted-light mb-4 absolute top-6 left-6">Flujo</p>
                <div class="h-24 w-full mt-2">
                    <canvas id="miniChart"></canvas>
                </div>
            </div>
        </div>

        <div id="view-goal" class="hidden fade-in space-y-6">
            <div class="text-center py-6">
                <p class="text-sm opacity-60 mb-2">Meta Objetivo</p>
                <div class="flex items-center justify-center gap-1">
                    <span class="text-3xl opacity-30">$</span>
                    <input id="inputGoal" type="number" class="bg-transparent text-5xl font-black text-center w-48 border-b-2 border-dashed border-primary/30 focus:border-primary outline-none" placeholder="0" onchange="App.updateVal('goal', this.value)">
                    <span class="material-symbols-rounded text-primary opacity-50 text-xl animate-pulse">edit</span>
                </div>
            </div>

            <div class="card-clean p-2 rounded-[2rem] flex items-center justify-between gap-2">
                <button onclick="App.modifyFund('sub')" class="h-16 w-16 rounded-full bg-danger/10 text-danger flex items-center justify-center active:scale-90 transition-transform">
                    <span class="material-symbols-rounded text-3xl">remove</span>
                </button>
                <div class="flex-1 text-center bg-black/5 dark:bg-white/5 rounded-2xl h-16 flex flex-col justify-center items-center px-4">
                    <input id="fundInput" type="number" placeholder="Monto" class="bg-transparent text-center font-bold text-xl w-full">
                </div>
                <button onclick="App.modifyFund('add')" class="h-16 w-16 rounded-full bg-success/10 text-success flex items-center justify-center active:scale-90 transition-transform">
                    <span class="material-symbols-rounded text-3xl">add</span>
                </button>
            </div>

            <div class="mt-4">
                <h3 class="text-xs font-bold uppercase opacity-50 mb-4 pl-4">Historial Reciente</h3>
                <div id="historyList" class="space-y-3"></div>
            </div>
        </div>

        <div id="view-incomes" class="hidden fade-in">
            <div class="flex items-center justify-between mb-6 px-2">
                <div>
                    <span class="text-xs font-bold text-success uppercase">Total Entradas</span>
                    <p id="totalIncomeDisplay" class="text-3xl font-black text-success">$0</p>
                </div>
                <button onclick="App.addItem('incomes')" class="bg-success text-white px-5 py-3 rounded-2xl font-bold shadow-lg shadow-success/30 active:scale-95 flex items-center gap-2 text-sm">
                    <span class="material-symbols-rounded text-lg">add</span> Nuevo
                </button>
            </div>

            <div class="card-clean p-5 rounded-3xl mb-6 border-l-4 border-l-primary flex items-center justify-between">
                <div>
                    <span class="text-xs font-bold uppercase opacity-60">Sueldo Base</span>
                    <div class="input-editable-container mt-1">
                        <span class="text-lg mr-1 opacity-50">$</span>
                        <input id="inputSalary" type="number" class="input-editable bg-transparent text-xl font-bold w-24 p-0 border-none" oninput="App.updateVal('salary', this.value)">
                        <span class="material-symbols-rounded text-xs input-editable-icon">edit</span>
                    </div>
                </div>
                <div class="w-10 h-10 rounded-full bg-primary/10 flex items-center justify-center text-primary">
                    <span class="material-symbols-rounded">work</span>
                </div>
            </div>

            <div id="incomesList" class="space-y-3"></div>
        </div>

        <div id="view-expenses" class="hidden fade-in">
            <div class="flex items-center justify-between mb-6 px-2">
                <div>
                    <span class="text-xs font-bold text-danger uppercase">Total Salidas</span>
                    <p id="totalExpenseDisplay" class="text-3xl font-black text-danger">$0</p>
                </div>
                <button onclick="App.addItem('expenses')" class="bg-danger text-white px-5 py-3 rounded-2xl font-bold shadow-lg shadow-danger/30 active:scale-95 flex items-center gap-2 text-sm">
                    <span class="material-symbols-rounded text-lg">add</span> Nuevo
                </button>
            </div>
            <div id="expensesList" class="space-y-3 pb-20"></div>
        </div>

    </div>

    <script>
        /**
         * MARIE FINANCE V3 - MOBILE REFACTOR
         */
        const CONFIG = {
            firebase: {
                apiKey: "AIzaSyANBc8ziutAX47V_iJpgdn-7O3S3kvI3Tc",
                authDomain: "marie-finance.firebaseapp.com",
                projectId: "marie-finance",
                storageBucket: "marie-finance.firebasestorage.app",
                messagingSenderId: "754175935134",
                appId: "1:754175935134:web:d159ae64d6ce56f51f318f",
                measurementId: "G-NX06QJHXL9"
            },
            collections: { users: 'users' }
        };

        let state = { userName: '', goal: 5000, accumulated: 0, salary: 600, incomes: [], expenses: [], history: [] };
        let chartInstance = null;
        let auth = null; let db = null;

        const Utils = {
            $: (id) => document.getElementById(id),
            formatMoney: (v) => new Intl.NumberFormat('en-US', { style: 'currency', currency: 'USD', maximumFractionDigits: 0 }).format(v),
            getIcon: (name) => {
                const n = (name||'').toLowerCase();
                if(n.includes('comida') || n.includes('cena')) return 'restaurant';
                if(n.includes('uber') || n.includes('carro')) return 'directions_car';
                if(n.includes('casa') || n.includes('renta')) return 'cottage';
                if(n.includes('wifi') || n.includes('net')) return 'wifi';
                if(n.includes('gym')) return 'fitness_center';
                return 'receipt_long';
            }
        };

        const Auth = {
            init: () => {
                try {
                    firebase.initializeApp(CONFIG.firebase);
                    auth = firebase.auth();
                    db = firebase.firestore();
                    auth.onAuthStateChanged(user => {
                        const overlay = Utils.$('loginOverlay');
                        if (user) {
                            overlay.classList.add('opacity-0', 'pointer-events-none');
                            Data.load(user.uid);
                        } else {
                            overlay.classList.remove('opacity-0', 'pointer-events-none');
                        }
                    });
                } catch(e) { console.error(e); }
            },
            login: () => {
                const p = new firebase.auth.GoogleAuthProvider();
                auth.signInWithPopup(p).catch(alert);
            },
            logout: () => {
                if(confirm('¿Salir?')) auth.signOut().then(() => location.reload());
            }
        };

        const Data = {
            load: async (uid) => {
                const doc = await db.collection(CONFIG.collections.users).doc(uid).get();
                if (doc.exists) state = { ...state, ...doc.data() };
                UI.renderAll();
            },
            save: () => {
                const user = auth.currentUser;
                if (user) db.collection(CONFIG.collections.users).doc(user.uid).set(state, { merge: true });
            }
        };

        const UI = {
            renderAll: () => {
                UI.renderIncomes();
                UI.renderExpenses();
                UI.renderHistory();
                App.calculate();
            },

            renderHistory: () => {
                const list = Utils.$('historyList');
                list.innerHTML = '';
                state.history.slice(0, 10).forEach(h => {
                    const isAdd = h.type === 'add';
                    list.innerHTML += `
                    <div class="flex items-center justify-between p-4 bg-white/50 dark:bg-white/5 rounded-2xl border border-white/20">
                        <div class="flex items-center gap-3">
                            <div class="w-8 h-8 rounded-full ${isAdd?'bg-success/10 text-success':'bg-danger/10 text-danger'} flex items-center justify-center">
                                <span class="material-symbols-rounded text-sm">${isAdd?'arrow_downward':'arrow_upward'}</span>
                            </div>
                            <span class="text-sm font-medium">${h.desc}</span>
                        </div>
                        <span class="text-sm font-bold ${isAdd?'text-success':'text-danger'}">${isAdd?'+':'-'}${Utils.formatMoney(h.amount)}</span>
                    </div>`;
                });
            },

            renderExpenses: () => {
                const list = Utils.$('expensesList');
                list.innerHTML = '';
                state.expenses.forEach(e => {
                    list.innerHTML += `
                    <div class="card-clean p-4 rounded-3xl flex items-center justify-between gap-3 group relative overflow-hidden">
                        <div class="flex items-center gap-4 flex-1">
                            <div class="w-12 h-12 rounded-2xl bg-danger/5 text-danger flex items-center justify-center shrink-0">
                                <span class="material-symbols-rounded">${Utils.getIcon(e.name)}</span>
                            </div>
                            <div class="flex flex-col w-full max-w-[140px]">
                                <div class="input-editable-container">
                                    <input value="${e.name}" class="input-editable bg-transparent font-bold text-sm w-full p-0 border-b border-transparent focus:border-danger/50 text-text-main-light dark:text-white placeholder-opacity-50" placeholder="Nombre..." onchange="App.updateItem('expenses', ${e.id}, 'name', this.value)">
                                    <span class="material-symbols-rounded text-[10px] input-editable-icon text-danger">edit</span>
                                </div>
                                <span class="text-[10px] opacity-50 mt-0.5">Mensual</span>
                            </div>
                        </div>
                        <div class="flex items-center gap-2">
                            <div class="bg-black/5 dark:bg-white/5 px-3 py-2 rounded-xl border border-transparent focus-within:border-danger/30 transition-colors">
                                <input type="number" value="${e.amount}" class="bg-transparent text-right font-black text-sm w-16 outline-none" onchange="App.updateItem('expenses', ${e.id}, 'amount', this.value)">
                            </div>
                            <button onclick="App.deleteItem('expenses', ${e.id})" class="w-8 h-8 rounded-full flex items-center justify-center text-text-muted-light hover:bg-danger/10 hover:text-danger transition-colors">
                                <span class="material-symbols-rounded text-lg">close</span>
                            </button>
                        </div>
                    </div>`;
                });
            },

            renderIncomes: () => {
                const list = Utils.$('incomesList');
                list.innerHTML = '';
                state.incomes.forEach(i => {
                    const total = (i.price - i.cost) * i.qty;
                    list.innerHTML += `
                    <div class="card-clean p-4 rounded-3xl flex flex-col gap-4 relative">
                        <div class="flex items-center justify-between border-b border-black/5 dark:border-white/5 pb-3">
                            <div class="flex items-center gap-3 flex-1">
                                <div class="w-10 h-10 rounded-2xl bg-success/5 text-success flex items-center justify-center">
                                    <span class="material-symbols-rounded">monetization_on</span>
                                </div>
                                <div class="input-editable-container w-full">
                                    <input value="${i.name}" class="input-editable bg-transparent font-bold text-sm w-full p-0 border-b border-transparent focus:border-success/50" placeholder="Proyecto..." onchange="App.updateItem('incomes', ${i.id}, 'name', this.value)">
                                    <span class="material-symbols-rounded text-[10px] input-editable-icon text-success">edit</span>
                                </div>
                            </div>
                            <button onclick="App.deleteItem('incomes', ${i.id})" class="text-text-muted-light hover:text-danger"><span class="material-symbols-rounded">close</span></button>
                        </div>
                        <div class="flex gap-3 text-xs">
                            <div class="flex-1 bg-black/5 dark:bg-white/5 rounded-xl p-2 text-center">
                                <span class="block opacity-50 text-[9px] uppercase">Precio</span>
                                <input type="number" value="${i.price}" class="w-full bg-transparent text-center font-bold outline-none" onchange="App.updateItem('incomes', ${i.id}, 'price', this.value)">
                            </div>
                            <div class="flex-1 bg-black/5 dark:bg-white/5 rounded-xl p-2 text-center">
                                <span class="block opacity-50 text-[9px] uppercase">Cant.</span>
                                <input type="number" value="${i.qty}" class="w-full bg-transparent text-center font-bold outline-none" onchange="App.updateItem('incomes', ${i.id}, 'qty', this.value)">
                            </div>
                            <div class="flex-1 bg-success/10 text-success rounded-xl p-2 text-center border border-success/20">
                                <span class="block opacity-50 text-[9px] uppercase">Neto</span>
                                <span class="font-black block">+${Utils.formatMoney(total)}</span>
                            </div>
                        </div>
                    </div>`;
                });
            },

            renderChart: (dataPoints) => {
                const ctx = Utils.$('miniChart');
                if(chartInstance) chartInstance.destroy();
                chartInstance = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: dataPoints.map((_,i) => i),
                        datasets: [{
                            data: dataPoints,
                            borderColor: '#b08968',
                            borderWidth: 2,
                            pointRadius: 0,
                            tension: 0.4,
                            fill: true,
                            backgroundColor: (context) => {
                                const ctx = context.chart.ctx;
                                const gradient = ctx.createLinearGradient(0, 0, 0, 100);
                                gradient.addColorStop(0, "rgba(176, 137, 104, 0.4)");
                                gradient.addColorStop(1, "rgba(176, 137, 104, 0)");
                                return gradient;
                            }
                        }]
                    },
                    options: { responsive: true, maintainAspectRatio: false, plugins: { legend: {display: false} }, scales: { x: {display: false}, y: {display: false} } }
                });
            }
        };

        const App = {
            calculate: () => {
                const totalIncome = state.salary + state.incomes.reduce((a,i) => a + ((i.price - i.cost) * i.qty), 0);
                const totalExpense = state.expenses.reduce((a,e) => a + e.amount, 0);
                const surplus = totalIncome - totalExpense;
                
                Utils.$('homeGoalDisplay').innerText = Utils.formatMoney(state.accumulated);
                Utils.$('surplusDisplay').innerText = (surplus > 0 ? '+' : '') + Utils.formatMoney(surplus) + " flujo";
                Utils.$('homeIncomeDisplay').innerText = Utils.formatMoney(totalIncome);
                Utils.$('homeExpenseDisplay').innerText = Utils.formatMoney(totalExpense);
                
                Utils.$('inputGoal').value = state.goal;
                Utils.$('inputSalary').value = state.salary;
                Utils.$('totalIncomeDisplay').innerText = Utils.formatMoney(totalIncome);
                Utils.$('totalExpenseDisplay').innerText = Utils.formatMoney(totalExpense);

                // Salud (Health Bar)
                const ratio = totalIncome > 0 ? (totalExpense / totalIncome) * 100 : 100;
                const width = Math.min(Math.max(100 - ratio, 5), 100);
                Utils.$('healthIndicator').style.width = `${width}%`;
                
                let hText = "Estable";
                if(width < 20) hText = "Crítico";
                else if(width > 60) hText = "Excelente";
                Utils.$('healthDesc').innerText = width < 20 ? "Gastos muy altos. ¡Cuidado!" : "Buen margen de maniobra.";
                Utils.$('healthBadge').innerText = hText;

                // Simple Data Points Gen for Chart
                const points = [state.accumulated - (surplus*2), state.accumulated - surplus, state.accumulated];
                UI.renderChart(points);
                Data.save();
            },

            navigateTo: (view) => {
                ['home', 'goal', 'incomes', 'expenses'].forEach(v => {
                    Utils.$(`view-${v}`).classList.add('hidden');
                });
                Utils.$(`view-${view}`).classList.remove('hidden');
                
                const titles = { home: 'Resumen', goal: 'Ahorros', incomes: 'Entradas', expenses: 'Salidas' };
                Utils.$('pageTitle').innerText = titles[view];
                
                const backBtn = Utils.$('backBtn');
                if(view === 'home') backBtn.classList.add('hidden');
                else backBtn.classList.remove('hidden');
                
                window.scrollTo(0,0);
            },

            updateVal: (key, val) => {
                state[key] = parseFloat(val) || 0;
                App.calculate();
            },

            modifyFund: (type) => {
                const el = Utils.$('fundInput');
                const val = parseFloat(el.value);
                if(!val) return el.focus();
                
                if(type === 'add') {
                    state.accumulated += val;
                    state.history.unshift({ type: 'add', desc: 'Depósito manual', amount: val });
                    confetti({ particleCount: 50, spread: 60, origin: { y: 0.7 }, colors: ['#6a994e', '#b08968'] });
                } else {
                    state.accumulated = Math.max(0, state.accumulated - val);
                    state.history.unshift({ type: 'sub', desc: 'Retiro manual', amount: val });
                }
                
                el.value = '';
                UI.renderHistory();
                App.calculate();
            },

            addItem: (type) => {
                const id = Date.now();
                if(type === 'incomes') state.incomes.push({ id, name: '', price: 0, cost: 0, qty: 1 });
                else state.expenses.push({ id, name: '', amount: 0 });
                type === 'incomes' ? UI.renderIncomes() : UI.renderExpenses();
            },

            deleteItem: (type, id) => {
                if(type === 'incomes') state.incomes = state.incomes.filter(i => i.id !== id);
                else state.expenses = state.expenses.filter(e => e.id !== id);
                UI.renderAll();
            },

            updateItem: (type, id, field, val) => {
                const arr = state[type];
                const item = arr.find(x => x.id === id);
                if(item) {
                    item[field] = field === 'name' ? val : (parseFloat(val)||0);
                    App.calculate();
                    if(type === 'incomes') UI.renderIncomes(); // Re-render for totals
                }
            },

            toggleTheme: () => document.documentElement.classList.toggle('dark')
        };

        // Init
        Auth.init();
    </script>
</body>
</html>
