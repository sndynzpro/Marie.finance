<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Meta Financiera</title>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore-compat.js"></script>
  <style>
    :root {
      --primary: #4361ee;
      --success: #06d6a0;
      --danger: #ef476f;
      --warning: #ffd166;
      --light: #f8f9fa;
      --dark: #212529;
      --gray: #6c757d;
    }
    * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Segoe UI', sans-serif; }
    body { background: #f5f7ff; color: var(--dark); padding: 20px; }
    .card { background: white; border-radius: 16px; padding: 24px; margin-bottom: 24px; box-shadow: 0 4px 12px rgba(0,0,0,0.05); }
    h1 { text-align: center; margin-bottom: 24px; color: var(--primary); }
    .goal-display { font-size: 2.5rem; font-weight: bold; text-align: center; margin: 16px 0; color: var(--primary); }
    .progress-container { height: 24px; background: #e9ecef; border-radius: 12px; overflow: hidden; margin: 16px 0; }
    .progress-bar { height: 100%; background: var(--success); transition: width 0.5s ease; }
    .input-group { display: flex; gap: 12px; margin: 16px 0; }
    input, button { padding: 12px; border: 1px solid #ced4da; border-radius: 8px; font-size: 1rem; }
    input { flex: 1; }
    button { background: var(--primary); color: white; cursor: pointer; transition: opacity 0.2s; }
    button:hover { opacity: 0.9; }
    button.danger { background: var(--danger); }
    .toast { position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); background: var(--dark); color: white; padding: 12px 24px; border-radius: 8px; opacity: 0; transition: opacity 0.3s; z-index: 1000; }
    .toast.show { opacity: 1; }
    canvas { max-width: 100%; height: 200px !important; }
    .history-item { display: flex; justify-content: space-between; padding: 12px 0; border-bottom: 1px solid #eee; }
    .history-amount.add { color: var(--success); }
    .history-amount.remove { color: var(--danger); }
    .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 2000; justify-content: center; align-items: center; }
    .modal-content { background: white; padding: 24px; border-radius: 16px; width: 90%; max-width: 400px; }
    .modal-buttons { display: flex; gap: 12px; margin-top: 20px; }
    .modal-buttons button { flex: 1; }
  </style>
</head>
<body>
  <h1>ðŸŽ¯ Mi Meta Financiera</h1>

  <div class="card">
    <div class="goal-display" id="detailSavedDisplay">$0</div>
    <div class="progress-container">
      <div class="progress-bar" id="progressBar" style="width: 0%"></div>
    </div>
    <div class="input-group">
      <input type="number" id="fundInput" placeholder="Monto" min="0" step="any" />
      <button id="btnAddFund">+ Ingresar</button>
      <button id="btnRemoveFund" class="danger">â€“ Retirar</button>
    </div>
  </div>

  <div class="card">
    <h3>Historial</h3>
    <div id="historyList"></div>
  </div>

  <!-- Modal de confirmaciÃ³n -->
  <div id="txModal" class="modal">
    <div class="modal-content">
      <h3 id="txModalTitle">Confirmar transacciÃ³n</h3>
      <p id="txModalDesc">Â¿EstÃ¡s seguro?</p>
      <div class="modal-buttons">
        <button id="btnCancelTx">Cancelar</button>
        <button id="btnConfirmTx" style="background:#06d6a0;">Confirmar</button>
      </div>
    </div>
  </div>

  <div class="toast" id="toast">Mensaje</div>

  <canvas id="chartCanvas"></canvas>

  <script>
    // ðŸ”§ ConfiguraciÃ³n de Firebase (REEMPLAZA CON TUS CREDENCIALES)
    const firebaseConfig = {
      apiKey: "TU_API_KEY",
      authDomain: "TU_PROYECTO.firebaseapp.com",
      projectId: "TU_PROYECTO",
      storageBucket: "TU_PROYECTO.appspot.com",
      messagingSenderId: "123456789",
      appId: "1:123456789:web:abcdef123456789"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
    const docRef = db.collection('savings').doc('main');

    let state = {
      goal: 5000,
      accumulated: 0,
      history: []
    };

    let pendingTransaction = null;

    // ===== UI =====
    const UI = {
      $: (id) => document.getElementById(id),
      animateNum: (id, value) => {
        const el = UI.$(id);
        if (!el) return;
        el.textContent = '$' + (value || 0).toFixed(2).replace(/\d(?=(\d{3})+\.)/g, '$&,');
      },
      renderChart: () => {
        const ctx = UI.$('chartCanvas').getContext('2d');
        ctx.clearRect(0, 0, ctx.canvas.width, ctx.canvas.height);
        const ratio = Math.min(1, state.accumulated / state.goal);
        ctx.fillStyle = '#e9ecef';
        ctx.fillRect(0, 0, ctx.canvas.width, ctx.canvas.height);
        ctx.fillStyle = '#06d6a0';
        ctx.fillRect(0, 0, ctx.canvas.width * ratio, ctx.canvas.height);
      },
      renderHistory: () => {
        const list = UI.$('historyList');
        list.innerHTML = '';
        state.history.slice(0, 10).forEach(item => {
          const div = document.createElement('div');
          div.className = 'history-item';
          const amountClass = item.amount >= 0 ? 'add' : 'remove';
          div.innerHTML = `
            <span>${new Date(item.date).toLocaleDateString()}</span>
            <span class="history-amount ${amountClass}">$${Math.abs(item.amount).toFixed(2)}</span>
          `;
          list.appendChild(div);
        });
      },
      showToast: (msg) => {
        const t = UI.$('toast');
        t.textContent = msg;
        t.classList.add('show');
        setTimeout(() => t.classList.remove('show'), 3000);
      },
      updateProgress: () => {
        const percent = Math.min(100, (state.accumulated / state.goal) * 100);
        UI.$('progressBar').style.width = percent + '%';
        UI.animateNum('detailSavedDisplay', state.accumulated);
        UI.renderChart();
      }
    };

    // ===== Utils =====
    const Utils = {
      $: (id) => document.getElementById(id)
    };

    // ===== Data =====
    const Data = {
      load: async () => {
        try {
          const doc = await docRef.get();
          if (doc.exists) {
            const data = doc.data();
            state = {
              goal: typeof data.goal === 'number' ? data.goal : 5000,
              accumulated: typeof data.accumulated === 'number' ? data.accumulated : 0,
              history: Array.isArray(data.history) ? data.history : []
            };
          }
          App.initUI();
        } catch (e) {
          console.error("Error al cargar:", e);
          UI.showToast("Error al cargar datos");
        }
      },
      save: async () => {
        try {
          await docRef.set({
            goal: state.goal,
            accumulated: state.accumulated,
            history: state.history
          });
        } catch (e) {
          console.error("Error al guardar:", e);
          UI.showToast("Error al guardar");
        }
      }
    };

    // ===== App =====
    const App = {
      initUI: () => {
        UI.updateProgress();
        UI.renderHistory();
      },
      modifyFund: (type) => {
        const i = Utils.$('fundInput');
        const val = i.value.trim();
        const a = parseFloat(val);
        if (!val || isNaN(a) || a <= 0) {
          UI.showToast("Ingresa un monto vÃ¡lido (> 0)");
          i.focus();
          return;
        }
        pendingTransaction = { type, amount: a };
        App.openTxModal();
      },
      openTxModal: () => {
        const title = pendingTransaction.type === 'add' ? 'Ingresar dinero' : 'Retirar dinero';
        const desc = `Â¿Confirmar ${pendingTransaction.type === 'add' ? 'ingreso' : 'retiro'} de $${pendingTransaction.amount.toFixed(2)}?`;
        UI.$('txModalTitle').textContent = title;
        UI.$('txModalDesc').textContent = desc;
        UI.$('txModal').style.display = 'flex';
      },
      closeTxModal: () => {
        UI.$('txModal').style.display = 'none';
        Utils.$('fundInput').value = '';
        pendingTransaction = null;
      },
      confirmTransaction: () => {
        if (!pendingTransaction) return;

        const amount = parseFloat(pendingTransaction.amount);
        if (isNaN(amount)) {
          UI.showToast("Monto invÃ¡lido");
          App.closeTxModal();
          return;
        }

        if (pendingTransaction.type === 'add') {
          state.accumulated += amount;
        } else {
          state.accumulated = Math.max(0, state.accumulated - amount);
        }

        // Registrar en historial
        state.history.unshift({
          id: Date.now(),
          date: new Date().toISOString(),
          desc: pendingTransaction.type === 'add' ? 'Ingreso manual' : 'Retiro manual',
          amount: pendingTransaction.type === 'add' ? amount : -amount,
          type: pendingTransaction.type
        });

        // Guardar y actualizar UI
        Data.save();
        UI.updateProgress();
        UI.renderHistory();
        App.closeTxModal();
      }
    };

    // ===== Eventos =====
    document.addEventListener('DOMContentLoaded', () => {
      UI.$('btnAddFund').addEventListener('click', () => App.modifyFund('add'));
      UI.$('btnRemoveFund').addEventListener('click', () => App.modifyFund('remove'));
      UI.$('btnCancelTx').addEventListener('click', App.closeTxModal);
      UI.$('btnConfirmTx').addEventListener('click', App.confirmTransaction);
      Data.load();
    });
  </script>
</body>
</html>
